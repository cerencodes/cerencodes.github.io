<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Ceren Unal">
<meta name="description" content="The first part of the Churn Prediction project explores the customer data set and builds a baseline model using the K-Nearest Neighbors algorithm.">
<title>Churn Prediction with Tidymodels - Part 1: K-Nearest Neighbors – Ceren Unal</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-1092c56c6cadf2eb47b1bc8063ab382a.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-db6453e5c38d5c9bf1f442aea4445b3d.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><style>html{ scroll-behavior: smooth; }</style>
<link rel="stylesheet" href="../../styles.css">
</head>
<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="navbar navbar-expand-lg " data-bs-theme="dark"><div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Ceren Unal</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
<li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../projects.html"> 
<span class="menu-text">Projects</span></a>
  </li>  
</ul>
</div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Content</h2>
   
  <ul>
<li><a href="#load-packages-data" id="toc-load-packages-data" class="nav-link active" data-scroll-target="#load-packages-data"><span class="header-section-number">1</span> Load Packages &amp; Data</a></li>
  <li><a href="#data-wrangling" id="toc-data-wrangling" class="nav-link" data-scroll-target="#data-wrangling"><span class="header-section-number">2</span> Data Wrangling</a></li>
  <li><a href="#data-exploration" id="toc-data-exploration" class="nav-link" data-scroll-target="#data-exploration"><span class="header-section-number">3</span> Data Exploration</a></li>
  <li><a href="#data-preparation-for-knn" id="toc-data-preparation-for-knn" class="nav-link" data-scroll-target="#data-preparation-for-knn"><span class="header-section-number">4</span> Data Preparation for KNN</a></li>
  <li><a href="#creating-the-model" id="toc-creating-the-model" class="nav-link" data-scroll-target="#creating-the-model"><span class="header-section-number">5</span> Creating the Model</a></li>
  <li>
<a href="#refining-the-model" id="toc-refining-the-model" class="nav-link" data-scroll-target="#refining-the-model"><span class="header-section-number">6</span> Refining the Model</a>
  <ul class="collapse">
<li><a href="#hyperparameter-grid" id="toc-hyperparameter-grid" class="nav-link" data-scroll-target="#hyperparameter-grid">Hyperparameter Grid</a></li>
  <li><a href="#thresholds" id="toc-thresholds" class="nav-link" data-scroll-target="#thresholds">Thresholds</a></li>
  <li><a href="#inverse-distance-weighting" id="toc-inverse-distance-weighting" class="nav-link" data-scroll-target="#inverse-distance-weighting">Inverse Distance Weighting</a></li>
  <li><a href="#manhattan-distance-weighting" id="toc-manhattan-distance-weighting" class="nav-link" data-scroll-target="#manhattan-distance-weighting">Manhattan Distance Weighting</a></li>
  </ul>
</li>
  <li>
<a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion"><span class="header-section-number">7</span> Conclusion</a>
  <ul class="collapse">
<li><a href="#next-steps" id="toc-next-steps" class="nav-link" data-scroll-target="#next-steps">Next Steps</a></li>
  </ul>
</li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Churn Prediction with Tidymodels - Part 1: K-Nearest Neighbors</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
  <div class="quarto-categories">
    <div class="quarto-category">classification</div>
    <div class="quarto-category">exploratory data analysis</div>
  </div>
  </div>

<div>
  <div class="description">
    The first part of the Churn Prediction project explores the customer data set and builds a baseline model using the K-Nearest Neighbors algorithm.
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Ceren Unal </p>
          </div>
  </div>
    
  
    
  </div>
  


</header><p><em>This study aims to develop a customer churn prediction model for the fictional streaming service Skystream, using a synthetic dataset.</em></p>
<p>Skystream is an emerging U.S.-based platform currently focusing its marketing efforts across eight states. The analysis employs a K-Nearest Neighbors (KNN) supervised learning algorithm to predict customer churn based on demographic and behavioral attributes within the dataset.</p>
<section id="load-packages-data" class="level2" data-number="1"><h2 data-number="1" class="anchored" data-anchor-id="load-packages-data">
<span class="header-section-number">1</span> Load Packages &amp; Data</h2>
<p>We will use the <strong>Tidyverse</strong> package for data processing. At first glance, the dataset appears to be in a tidy format, with each variable represented as a column and each observation as a row.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://boxuancui.github.io/DataExplorer/">DataExplorer</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com">patchwork</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggobi.github.io/ggally/">GGally</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jacobkap/fastDummies">fastDummies</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/Tazinho/snakecase">snakecase</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidymodels.tidymodels.org">tidymodels</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidymodels/themis">themis</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidymodels/yardstick">yardstick</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/therneau/survival">survival</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rpkgs.datanovia.com/survminer/index.html">survminer</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/EmilHvitfeldt/paletteer">paletteer</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">skystream</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span>file <span class="op">=</span> <span class="st">"skystream.csv"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We have 900 observations and 14 variables. Several of these numeric and character variables should be converted to factors for analysis purposes. We will want to see the distribution of demographic and behavioral characteristics in our customer base.</p>
<p>We also have 883 missing values that we need to look into. The majority of the missing values are in the CancelDate variable, which is expected as active users are not meant to have a cancel date. The remaining 2 missing values are in the JoinDate variable.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">skimr</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/skimr/reference/skim.html">skim</a></span><span class="op">(</span><span class="va">skystream</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Data summary</caption>
<tbody>
<tr class="odd">
<td style="text-align: left;">Name</td>
<td style="text-align: left;">skystream</td>
</tr>
<tr class="even">
<td style="text-align: left;">Number of rows</td>
<td style="text-align: left;">900</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Number of columns</td>
<td style="text-align: left;">14</td>
</tr>
<tr class="even">
<td style="text-align: left;">_______________________</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Column type frequency:</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">character</td>
<td style="text-align: left;">5</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Date</td>
<td style="text-align: left;">2</td>
</tr>
<tr class="even">
<td style="text-align: left;">numeric</td>
<td style="text-align: left;">7</td>
</tr>
<tr class="odd">
<td style="text-align: left;">________________________</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">Group variables</td>
<td style="text-align: left;">None</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: character</strong></p>
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 22%">
<col style="width: 13%">
<col style="width: 18%">
<col style="width: 5%">
<col style="width: 5%">
<col style="width: 8%">
<col style="width: 12%">
<col style="width: 14%">
</colgroup>
<thead><tr class="header">
<th style="text-align: left;">skim_variable</th>
<th style="text-align: right;">n_missing</th>
<th style="text-align: right;">complete_rate</th>
<th style="text-align: right;">min</th>
<th style="text-align: right;">max</th>
<th style="text-align: right;">empty</th>
<th style="text-align: right;">n_unique</th>
<th style="text-align: right;">whitespace</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Genre</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">18</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">State</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">SubscriptionTier</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">12</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">Gender</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">DevicePreference</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">0</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: Date</strong></p>
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 17%">
<col style="width: 12%">
<col style="width: 17%">
<col style="width: 13%">
<col style="width: 13%">
<col style="width: 13%">
<col style="width: 11%">
</colgroup>
<thead><tr class="header">
<th style="text-align: left;">skim_variable</th>
<th style="text-align: right;">n_missing</th>
<th style="text-align: right;">complete_rate</th>
<th style="text-align: left;">min</th>
<th style="text-align: left;">max</th>
<th style="text-align: left;">median</th>
<th style="text-align: right;">n_unique</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">JoinDate</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: left;">2025-01-02</td>
<td style="text-align: left;">2025-03-30</td>
<td style="text-align: left;">2025-02-06</td>
<td style="text-align: right;">88</td>
</tr>
<tr class="even">
<td style="text-align: left;">CancelDate</td>
<td style="text-align: right;">821</td>
<td style="text-align: right;">0.09</td>
<td style="text-align: left;">2025-03-05</td>
<td style="text-align: left;">2025-10-30</td>
<td style="text-align: left;">2025-04-26</td>
<td style="text-align: right;">49</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: numeric</strong></p>
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 23%">
<col style="width: 9%">
<col style="width: 13%">
<col style="width: 6%">
<col style="width: 6%">
<col style="width: 5%">
<col style="width: 6%">
<col style="width: 6%">
<col style="width: 6%">
<col style="width: 7%">
<col style="width: 5%">
</colgroup>
<thead><tr class="header">
<th style="text-align: left;">skim_variable</th>
<th style="text-align: right;">n_missing</th>
<th style="text-align: right;">complete_rate</th>
<th style="text-align: right;">mean</th>
<th style="text-align: right;">sd</th>
<th style="text-align: right;">p0</th>
<th style="text-align: right;">p25</th>
<th style="text-align: right;">p50</th>
<th style="text-align: right;">p75</th>
<th style="text-align: right;">p100</th>
<th style="text-align: left;">hist</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">CustomerID</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">461.61</td>
<td style="text-align: right;">278.32</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">225.75</td>
<td style="text-align: right;">450.50</td>
<td style="text-align: right;">675.25</td>
<td style="text-align: right;">1000.00</td>
<td style="text-align: left;">▇▇▇▇▃</td>
</tr>
<tr class="even">
<td style="text-align: left;">Age</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">39.61</td>
<td style="text-align: right;">12.39</td>
<td style="text-align: right;">18.00</td>
<td style="text-align: right;">29.00</td>
<td style="text-align: right;">38.00</td>
<td style="text-align: right;">49.00</td>
<td style="text-align: right;">68.00</td>
<td style="text-align: left;">▇▇▇▅▃</td>
</tr>
<tr class="odd">
<td style="text-align: left;">NumberMonthsActive</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">4.10</td>
<td style="text-align: right;">2.12</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">3.00</td>
<td style="text-align: right;">4.00</td>
<td style="text-align: right;">5.00</td>
<td style="text-align: right;">12.00</td>
<td style="text-align: left;">▅▇▃▁▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">AvgSessionLength</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">50.26</td>
<td style="text-align: right;">20.61</td>
<td style="text-align: right;">20.00</td>
<td style="text-align: right;">33.00</td>
<td style="text-align: right;">45.00</td>
<td style="text-align: right;">65.00</td>
<td style="text-align: right;">90.00</td>
<td style="text-align: left;">▇▇▆▃▅</td>
</tr>
<tr class="odd">
<td style="text-align: left;">MonthsSinceLastActivity</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.78</td>
<td style="text-align: right;">0.47</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">3.00</td>
<td style="text-align: left;">▃▇▁▁▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">AvgWatchHoursPerMonth</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">20.49</td>
<td style="text-align: right;">9.02</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: right;">13.00</td>
<td style="text-align: right;">19.00</td>
<td style="text-align: right;">29.00</td>
<td style="text-align: right;">65.00</td>
<td style="text-align: left;">▇▇▂▁▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">RevenueYTD</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">54.20</td>
<td style="text-align: right;">40.90</td>
<td style="text-align: right;">5.99</td>
<td style="text-align: right;">19.99</td>
<td style="text-align: right;">39.96</td>
<td style="text-align: right;">79.95</td>
<td style="text-align: right;">239.88</td>
<td style="text-align: left;">▇▃▂▁▁</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Two users have 4 NumberMonthsActive but not JoinDate or CancelDate, hence we aren’t able to trace back from CancelDate to fill in their JoinDate. However, we aren’t interested in JoinDate as a variable in our churn model so we not be removing these users with NA values from our data set.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">skystream</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">JoinDate</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 5%">
<col style="width: 9%">
<col style="width: 3%">
<col style="width: 8%">
<col style="width: 2%">
<col style="width: 3%">
<col style="width: 4%">
<col style="width: 5%">
<col style="width: 9%">
<col style="width: 8%">
<col style="width: 12%">
<col style="width: 11%">
<col style="width: 5%">
<col style="width: 8%">
</colgroup>
<thead><tr class="header">
<th style="text-align: right;">CustomerID</th>
<th style="text-align: left;">Genre</th>
<th style="text-align: left;">State</th>
<th style="text-align: left;">SubscriptionTier</th>
<th style="text-align: right;">Age</th>
<th style="text-align: left;">Gender</th>
<th style="text-align: left;">JoinDate</th>
<th style="text-align: left;">CancelDate</th>
<th style="text-align: right;">NumberMonthsActive</th>
<th style="text-align: right;">AvgSessionLength</th>
<th style="text-align: right;">MonthsSinceLastActivity</th>
<th style="text-align: right;">AvgWatchHoursPerMonth</th>
<th style="text-align: right;">RevenueYTD</th>
<th style="text-align: left;">DevicePreference</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">714</td>
<td style="text-align: left;">Documentary</td>
<td style="text-align: left;">TX</td>
<td style="text-align: left;">Family</td>
<td style="text-align: right;">24</td>
<td style="text-align: left;">F</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">75</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">29</td>
<td style="text-align: right;">79.96</td>
<td style="text-align: left;">Smart TV</td>
</tr>
<tr class="even">
<td style="text-align: right;">71</td>
<td style="text-align: left;">Children &amp; Family</td>
<td style="text-align: left;">WA</td>
<td style="text-align: left;">Family</td>
<td style="text-align: right;">44</td>
<td style="text-align: left;">M</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">78</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">28</td>
<td style="text-align: right;">79.96</td>
<td style="text-align: left;">Laptop</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>Checking for unique values in each categorical variable, we find that the genre Drama is coded as Dramas for some observations, we need to recode these.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">skystream</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/where.html">where</a></span><span class="op">(</span><span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">is.character</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span> <span class="op">||</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">is.factor</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">unique</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>$Genre
[1] "Horror"             "Action &amp; Adventure" "Documentary"       
[4] "Children &amp; Family"  "Drama"              "Comedy"            
[7] "Dramas"            

$State
[1] "IL" "TX" "FL" "GA" "WA" "NY" "CA" "CO" "AZ"

$SubscriptionTier
[1] "Premium"      "Family"       "Ad-Supported" "Basic"       

$Gender
[1] "M" "F" "O"

$DevicePreference
[1] "Mobile"   "Smart TV" "Tablet"   "Laptop"   "Mixed"   </code></pre>
</div>
</div>
</section><section id="data-wrangling" class="level2" data-number="2"><h2 data-number="2" class="anchored" data-anchor-id="data-wrangling">
<span class="header-section-number">2</span> Data Wrangling</h2>
<p>We create a new variable for Churn based on whether the user has a CancelDate or not and clean up our Genre variable.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">skystream</span> <span class="op">&lt;-</span> <span class="va">skystream</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    Churn <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">CancelDate</span><span class="op">)</span>, <span class="fl">0L</span>, <span class="fl">1L</span><span class="op">)</span> <span class="co">#return 1 if there is a CancelDate</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate</a></span><span class="op">(</span><span class="va">Churn</span>, .after <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co">#position it after column 1 </span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Genre <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/recode.html">recode</a></span><span class="op">(</span><span class="va">Genre</span>, <span class="st">"Dramas"</span> <span class="op">=</span> <span class="st">"Drama"</span><span class="op">)</span>, <span class="co">#replace Dramas with Drama</span></span>
<span>         SubscriptionTier <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">SubscriptionTier</span>,</span>
<span>                              levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Ad-Supported"</span>,<span class="st">"Basic"</span>, <span class="st">"Premium"</span>, <span class="st">"Family"</span><span class="op">)</span>, <span class="co">#relevel tiers</span></span>
<span>                              ordered <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="data-exploration" class="level2" data-number="3"><h2 data-number="3" class="anchored" data-anchor-id="data-exploration">
<span class="header-section-number">3</span> Data Exploration</h2>
<p>There are users from 9 states in the data set, equally distributed, minus the AZ user base which seems to be extremely low. There might be a mistake in the records.</p>
<p>Female users form the majority of the user base, and the device preference is mostly mobile. Basic is the most preferred subscription tier, while Ad-Support is the least despite being the cheapest option. Users seem willing to pay more for the ad-free experience.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">device_plot</span> <span class="op">&lt;-</span> <span class="va">skystream</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_inorder.html">fct_infreq</a></span><span class="op">(</span><span class="va">DevicePreference</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"#7C873EFF"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Device Preference"</span>, x <span class="op">=</span> <span class="st">"Device"</span>, y <span class="op">=</span> <span class="st">"Count"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">state_plot</span> <span class="op">&lt;-</span> <span class="va">skystream</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_inorder.html">fct_infreq</a></span><span class="op">(</span><span class="va">State</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"#DB4743FF"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"State"</span>, x <span class="op">=</span> <span class="st">"State"</span>, y <span class="op">=</span> <span class="st">"Count"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">gender_plot</span> <span class="op">&lt;-</span> <span class="va">skystream</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_inorder.html">fct_infreq</a></span><span class="op">(</span><span class="va">Gender</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"#F5AF4DFF"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Gender"</span>, x <span class="op">=</span> <span class="st">"Gender"</span>, y <span class="op">=</span> <span class="st">"Count"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">tier_plot</span> <span class="op">&lt;-</span> <span class="va">skystream</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_inorder.html">fct_infreq</a></span><span class="op">(</span><span class="va">SubscriptionTier</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"#5495CFFF"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Subscription Tier"</span>, x <span class="op">=</span> <span class="st">"Tier"</span>, y <span class="op">=</span> <span class="st">"Count"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> </span>
<span></span>
<span></span>
<span><span class="va">patch_plot</span> <span class="op">&lt;-</span> <span class="va">state_plot</span> <span class="op">+</span> <span class="va">gender_plot</span> <span class="op">+</span> <span class="va">tier_plot</span> <span class="op">+</span> <span class="va">device_plot</span> </span>
<span></span>
<span><span class="va">patch_plot</span> <span class="op">+</span> <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_annotation.html">plot_annotation</a></span><span class="op">(</span></span>
<span>  title <span class="op">=</span> <span class="st">'User Characteristics'</span></span>
<span><span class="op">)</span> <span class="op">&amp;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span></span>
<span>    plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> </span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="index_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Age distribution is right skewed, with the majority of our user base falling between ages 20 to 40.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">skystream</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">Age</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span></span>
<span>    bins <span class="op">=</span> <span class="fl">9</span>,  </span>
<span>    fill <span class="op">=</span> <span class="st">"#5495CFFF"</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"white"</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Age Distribution"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span></span>
<span>    plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>    panel.grid.major.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="index_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Genre preferences are quite evenly distributed within the user base.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="index_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Tiers by State reveals an interesting pattern. In TX and WA, Premium tier dominates while in CA and GA the leading tier is Family. CO and FL subscribe mainly to Basic tier, and IL and NY to Ad-Supported.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">skystream</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">State</span>, fill <span class="op">=</span> <span class="va">SubscriptionTier</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Subscription Tiers by State"</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"State"</span>, y <span class="op">=</span> <span class="st">"Subscribers"</span>, fill <span class="op">=</span> <span class="st">"Tier"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">13</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/paletteer/man/ggplot2-scales-discrete.html">scale_fill_paletteer_d</a></span><span class="op">(</span><span class="st">"nationalparkcolors::Badlands"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">45</span>, hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, </span>
<span>        legend.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>        plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span>, face <span class="op">=</span> <span class="st">"bold"</span>, size <span class="op">=</span> <span class="fl">16</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="index_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>There is strong correlation between AvgWatchHoursPerMonth, AvgSessionLength, which seems logical in that users who spend more time on the platform per session, also spend more hours watching movies per month. It may also signal that increasing session duration is positive user behavior, instead of a negative behavior such as unproductive scrolling and browsing for content.</p>
<p>No strong correlation between continious variables and Churn.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">skystream</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">Age</span>, <span class="va">NumberMonthsActive</span>, <span class="va">AvgWatchHoursPerMonth</span>, <span class="va">AvgSessionLength</span>, <span class="va">Churn</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggobi.github.io/ggally/reference/ggpairs.html">ggpairs</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="index_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>No strong correlation between categorical variables and Churn.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://CRAN.R-project.org/package=rcompanion">rcompanion</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/rcompanion/man/cramerV.html">cramerV</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">skystream</span><span class="op">$</span><span class="va">Churn</span>, <span class="va">skystream</span><span class="op">$</span><span class="va">Gender</span><span class="op">)</span><span class="op">)</span>        </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Cramer V 
 0.02628 </code></pre>
</div>
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/rcompanion/man/cramerV.html">cramerV</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">skystream</span><span class="op">$</span><span class="va">Churn</span>, <span class="va">skystream</span><span class="op">$</span><span class="va">Genre</span><span class="op">)</span><span class="op">)</span>          </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Cramer V 
  0.1844 </code></pre>
</div>
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/rcompanion/man/cramerV.html">cramerV</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">skystream</span><span class="op">$</span><span class="va">Churn</span>, <span class="va">skystream</span><span class="op">$</span><span class="va">SubscriptionTier</span><span class="op">)</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Cramer V 
  0.1822 </code></pre>
</div>
</div>
<p>Less than 10% of users have churned, out of 900 users.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">skystream</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">Churn</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>prop <span class="op">=</span> <span class="va">n</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">Churn</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">n</span>, fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">Churn</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_col</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_text</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>label <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/percent_format.html">percent</a></span><span class="op">(</span><span class="va">prop</span>, accuracy <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            vjust <span class="op">=</span> <span class="op">-</span><span class="fl">0.5</span>, size <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"0"</span> <span class="op">=</span> <span class="st">"grey70"</span>, <span class="st">"1"</span> <span class="op">=</span> <span class="st">"#DB4743FF"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html">scale_x_discrete</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"0"</span> <span class="op">=</span> <span class="st">"No"</span>, <span class="st">"1"</span> <span class="op">=</span> <span class="st">"Yes"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Churn Status"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"Proportion of Users"</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"Churn vs No Churn with Percentages"</span>,</span>
<span>       fill <span class="op">=</span> <span class="st">"Churn"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="index_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>There is a significant drop among users after 9 months.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">NumberMonthsActive</span>, <span class="va">Churn</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>, <span class="va">skystream</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/survminer/man/ggsurvplot.html">ggsurvplot</a></span><span class="op">(</span><span class="va">fit</span>, conf.int <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>           xlab <span class="op">=</span> <span class="st">"Months"</span>,</span>
<span>           ylab <span class="op">=</span> <span class="st">"Proportion Still Active"</span>,</span>
<span>           title <span class="op">=</span> <span class="st">"User Retention Curve"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="index_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The 9 month retention is similar across genders.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">fit_gender</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">NumberMonthsActive</span>, <span class="va">Churn</span><span class="op">)</span> <span class="op">~</span> <span class="va">Gender</span>, <span class="va">skystream</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/survminer/man/ggsurvplot.html">ggsurvplot</a></span><span class="op">(</span><span class="va">fit_gender</span>, <span class="va">skystream</span>,</span>
<span>           xlab <span class="op">=</span> <span class="st">"Months"</span>,</span>
<span>           ylab <span class="op">=</span> <span class="st">"Proportion Still Active"</span>,</span>
<span>           title <span class="op">=</span> <span class="st">"User Retention Curve by Gender"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="index_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Horror and Documentary fans show significant loss in retention over time. They might be losing interest due to a lack of new content in these genres.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">fit_genre</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">NumberMonthsActive</span>, <span class="va">Churn</span><span class="op">)</span> <span class="op">~</span> <span class="va">Genre</span>, <span class="va">skystream</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/survminer/man/ggsurvplot.html">ggsurvplot</a></span><span class="op">(</span><span class="va">fit_genre</span>, <span class="va">skystream</span>,</span>
<span>           xlab <span class="op">=</span> <span class="st">"Months"</span>,</span>
<span>           ylab <span class="op">=</span> <span class="st">"Proportion Still Active"</span>,</span>
<span>           title <span class="op">=</span> <span class="st">"User Retention Curve by Genre"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="index_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Retention is much stronger in higher tiers. Ad-supported and Basic seem to lose steam around 6 months.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">fit_tier</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">NumberMonthsActive</span>, <span class="va">Churn</span><span class="op">)</span> <span class="op">~</span> <span class="va">SubscriptionTier</span>, <span class="va">skystream</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/survminer/man/ggsurvplot.html">ggsurvplot</a></span><span class="op">(</span><span class="va">fit_tier</span>, <span class="va">skystream</span>,</span>
<span>           xlab <span class="op">=</span> <span class="st">"Months"</span>,</span>
<span>           ylab <span class="op">=</span> <span class="st">"Proportion Still Active"</span>,</span>
<span>           title <span class="op">=</span> <span class="st">"User Retention Curve by Tier"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="index_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section><section id="data-preparation-for-knn" class="level2" data-number="4"><h2 data-number="4" class="anchored" data-anchor-id="data-preparation-for-knn">
<span class="header-section-number">4</span> Data Preparation for KNN</h2>
<p>After initial data exploration, we prepare data for KNN. We ensure that all continuous variables are numeric and we drop the variables that we will not be using in our model. RevenueYTD is dropped as it would be reduntant when we have both SubscriptionTier and NumberMonthsActive in the model, which directly determine this 3rd variable.</p>
<p>We convert the Churn variable, which indicates whether a customer has churned, into a factor so it can be treated as a categorical classification outcome.</p>
<p>The categorical variables are recoded as dummy variables so KNN can compute distance across categories.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Define columns by role/type</span></span>
<span><span class="va">num_cols</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"NumberMonthsActive"</span>, <span class="st">"AvgSessionLength"</span>, <span class="st">"Age"</span>,</span>
<span>               <span class="st">"MonthsSinceLastActivity"</span>, <span class="st">"AvgWatchHoursPerMonth"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cat_cols</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"SubscriptionTier"</span>, <span class="st">"Genre"</span>, <span class="st">"State"</span>, <span class="st">"Gender"</span>, <span class="st">"DevicePreference"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">skystream_knn</span> <span class="op">&lt;-</span> <span class="va">skystream</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">#Make “Churned” the first level so tidymodels treats Churned as the positive class</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Churn <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">Churn</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Churned"</span>, <span class="st">"Active"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  </span>
<span>  <span class="co"># Ensure numericals are numeric</span></span>
<span>   <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html">all_of</a></span><span class="op">(</span><span class="va">num_cols</span><span class="op">)</span>, <span class="va">as.numeric</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  </span>
<span>  <span class="co"># Remove columns not suitable as KNN features </span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">CustomerID</span>, <span class="op">-</span><span class="va">JoinDate</span>, <span class="op">-</span><span class="va">CancelDate</span>, <span class="op">-</span><span class="va">RevenueYTD</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  </span>
<span>  <span class="co"># One-hot encode categoricals (drop first level to avoid redundancy)</span></span>
<span>  <span class="fu">fastDummies</span><span class="fu">::</span><span class="fu"><a href="https://jacobkap.github.io/fastDummies/reference/dummy_cols.html">dummy_cols</a></span><span class="op">(</span></span>
<span>    select_columns <span class="op">=</span> <span class="va">cat_cols</span>,</span>
<span>    remove_first_dummy <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    remove_selected_columns <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  </span>
<span>  <span class="co">#Ensure column names are all in tidy format</span></span>
<span>   <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename_with</a></span><span class="op">(</span><span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/snakecase/man/to_any_case.html">to_any_case</a></span><span class="op">(</span><span class="va">.</span>, case <span class="op">=</span> <span class="st">"upper_camel"</span><span class="op">)</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="creating-the-model" class="level2" data-number="5"><h2 data-number="5" class="anchored" data-anchor-id="creating-the-model">
<span class="header-section-number">5</span> Creating the Model</h2>
<p>We set the seed using set.seed() to ensure the observations are random and consistent. We use initial_split() to divide the dataset, with 80% allocated for training and 20% for testing. Then, we use the strata = churned argument to ensure the class distribution of the churned variable is kept in both the training and testing sets. Finally, we extract the datasets for training and testing using split.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">867</span><span class="op">)</span></span>
<span><span class="va">Split80</span> <span class="op">=</span> <span class="fu">initial_split</span><span class="op">(</span><span class="va">skystream_knn</span>, prop <span class="op">=</span> <span class="fl">0.80</span>, strata <span class="op">=</span> <span class="va">Churn</span><span class="op">)</span></span>
<span></span>
<span><span class="va">DataTrain</span> <span class="op">&lt;-</span> <span class="fu">training</span><span class="op">(</span><span class="va">Split80</span><span class="op">)</span> </span>
<span><span class="va">DataTest</span>  <span class="op">&lt;-</span> <span class="fu">testing</span><span class="op">(</span><span class="va">Split80</span><span class="op">)</span>  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We define the recipe for preprocessing. We specify the recipe with Churn ~ ., which means all other columns, such as Age and NumberMonthsActive, will be used to predict whether a customer churned.</p>
<p>We use step_normalize(all_predictors()) to scale all predictor variables and ensure they are all within the same scale.</p>
<p>Since our 900 observation data is highly imbalanced, churned users comprising less than 10% of the user base, we use SMOTE from the themis package to create new synthetic samples of the minority class. SMOTE can create realistic “synthetic churn customers” so the KNN model doesn’t always default to predicting “Active.” It is less likely to overfit compared to naive oversampling in order to balance classes.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">Recipe</span> <span class="op">=</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html">recipe</a></span><span class="op">(</span><span class="va">Churn</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">DataTrain</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_normalize.html">step_normalize</a></span><span class="op">(</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html">all_predictors</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  <span class="co"># scale numeric features</span></span>
<span>  <span class="fu"><a href="https://themis.tidymodels.org/reference/step_smote.html">step_smote</a></span><span class="op">(</span><span class="va">Churn</span><span class="op">)</span><span class="co"># apply SMOTE to balance churn vs active </span></span>
<span></span>
<span><span class="va">ModelDesign</span> <span class="op">=</span> <span class="fu">nearest_neighbor</span><span class="op">(</span>neighbors<span class="op">=</span><span class="fu">tune</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>               <span class="fu">set_engine</span><span class="op">(</span><span class="st">"kknn"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>               <span class="fu">set_mode</span><span class="op">(</span><span class="st">"classification"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">TuneWFModel</span> <span class="op">=</span> <span class="fu">workflow</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>            <span class="fu">add_recipe</span><span class="op">(</span><span class="va">Recipe</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>            <span class="fu">add_model</span><span class="op">(</span><span class="va">ModelDesign</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>To avoid over-fitting, we are looking for the ideal number of neighbors (k) for our model to consider when classifying data points.To tune our model to the best value of <em>k,</em> we first create a hyper-parameter grid for tuning, a dataframe of possible k values (k = 1 to k = 15). For each 15 hyperparameters (k = 1 to k = 15), we will run 5 folds to cross-validate our data.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ParGrid</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>neighbors<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">15</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">FoldsForTuning</span><span class="op">=</span><span class="fu">vfold_cv</span><span class="op">(</span><span class="va">DataTrain</span>, v<span class="op">=</span><span class="fl">5</span>,</span>
<span>                        strata<span class="op">=</span><span class="va">Churn</span><span class="op">)</span></span>
<span></span>
<span><span class="va">TuneResults</span><span class="op">=</span><span class="fu">tune_grid</span><span class="op">(</span><span class="va">TuneWFModel</span>, resamples<span class="op">=</span><span class="va">FoldsForTuning</span>,</span>
<span>                      grid<span class="op">=</span><span class="va">ParGrid</span>, metrics<span class="op">=</span><span class="fu"><a href="https://yardstick.tidymodels.org/reference/metric_set.html">metric_set</a></span><span class="op">(</span><span class="va">roc_auc</span>, <span class="fu">yardstick</span><span class="fu">::</span><span class="va"><a href="https://yardstick.tidymodels.org/reference/accuracy.html">accuracy</a></span>, <span class="va">sens</span>, <span class="va">spec</span>, <span class="va">f_meas</span><span class="op">)</span><span class="op">)</span> <span class="co">#specify yardstick package to avoide conflict with rcompanion</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">TuneResults</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="index_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>After running the best hyper parameters. We went ahead and tuned the results using the metric ROC AUC, which is meant to find the balance between true positive rate and false positive rate. We want to find the optimal point where we have the highest percentage of correctly identified churn cases against the lowest number of wrongly identified active users.</p>
<p>Based on ROC AUC, the best value for the hyper-parameter is 11.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">BestHyperParameter</span><span class="op">=</span><span class="fu">select_best</span><span class="op">(</span><span class="va">TuneResults</span>, metric<span class="op">=</span><span class="st">"roc_auc"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">BestHyperParameter</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 2
  neighbors .config              
      &lt;int&gt; &lt;chr&gt;                
1        11 Preprocessor1_Model11</code></pre>
</div>
</div>
<p>Based on the results of our Best Model, we see that 6 users from the data were a true positives, meaning they were correctly predicted to churn base on our variables given. We have a <strong>35% true positive rate</strong>.</p>
<p>True positive rate (also called sensitivity or recall) is the most important metric in churn prediction, given our goal is to correctly identify customers who will churn before they can do so. The model should be able to identify the highest number of churners correctly out of all those who actually end up churning churn.</p>
<p>This model was able to identify only 35% of the churners, and the precision is very low. <strong>Out of all the users model predicts will churn, only 20% actually churn</strong>, the number of false positives is very high. This could lead to an inefficient allocation of the retention budget.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">WFModelBest</span><span class="op">=</span><span class="va">TuneWFModel</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">finalize_workflow</span><span class="op">(</span><span class="va">BestHyperParameter</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">fit</span><span class="op">(</span><span class="va">DataTrain</span><span class="op">)</span></span>
<span></span>
<span><span class="va">PredictionBestModel</span><span class="op">=</span><span class="fu">augment</span><span class="op">(</span><span class="va">WFModelBest</span>, <span class="va">DataTest</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://yardstick.tidymodels.org/reference/conf_mat.html">conf_mat</a></span><span class="op">(</span><span class="va">PredictionBestModel</span>, truth<span class="op">=</span><span class="va">Churn</span>,</span>
<span>         estimate<span class="op">=</span><span class="va">.pred_class</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cm</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>          Truth
Prediction Churned Active
   Churned       6     24
   Active       11    139</code></pre>
</div>
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">cm</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead><tr class="header">
<th style="text-align: left;">.metric</th>
<th style="text-align: left;">.estimator</th>
<th style="text-align: right;">.estimate</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">accuracy</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.8055556</td>
</tr>
<tr class="even">
<td style="text-align: left;">kap</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.1532258</td>
</tr>
<tr class="odd">
<td style="text-align: left;">sens</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.3529412</td>
</tr>
<tr class="even">
<td style="text-align: left;">spec</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.8527607</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ppv</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.2000000</td>
</tr>
<tr class="even">
<td style="text-align: left;">npv</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.9266667</td>
</tr>
<tr class="odd">
<td style="text-align: left;">mcc</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.1614174</td>
</tr>
<tr class="even">
<td style="text-align: left;">j_index</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.2057019</td>
</tr>
<tr class="odd">
<td style="text-align: left;">bal_accuracy</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.6028510</td>
</tr>
<tr class="even">
<td style="text-align: left;">detection_prevalence</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.1666667</td>
</tr>
<tr class="odd">
<td style="text-align: left;">precision</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.2000000</td>
</tr>
<tr class="even">
<td style="text-align: left;">recall</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.3529412</td>
</tr>
<tr class="odd">
<td style="text-align: left;">f_meas</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.2553191</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>We need to refine our model further to get the best results out of KNN.</p>
</section><section id="refining-the-model" class="level2" data-number="6"><h2 data-number="6" class="anchored" data-anchor-id="refining-the-model">
<span class="header-section-number">6</span> Refining the Model</h2>
<section id="hyperparameter-grid" class="level3"><h3 class="anchored" data-anchor-id="hyperparameter-grid">Hyperparameter Grid</h3>
<p>Hyperparameter grids with k = [1:30] and k = [1:60] were also tested, which gave k = 11 (same as k = 15) and k = 43 as best hyperparameters. When k = 43 was used to tune the model, recall increased but precision dropped further.</p>
<p>As a result, we maintain k = 11 as a balanced hyperparameter, that also uses less computational power.</p>
</section><section id="thresholds" class="level3"><h3 class="anchored" data-anchor-id="thresholds">Thresholds</h3>
<p>As we have an imbalanced data set, we tuned our hyperparameter to ROC AUC, settling on the k with the highest AUC. ROC AUC trains our model to be good at ranking positives ahead of negatives regardless of the threshold.</p>
<p>Now we can move on to determining the best threshold to balance recall and precision.</p>
<p>We will scan a range of thresholds and pick the threshold that maximizes F1.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Try thresholds from 0.05 to 0.95</span></span>
<span><span class="va">ths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0.05</span>, <span class="fl">0.95</span>, by <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span></span>
<span></span>
<span><span class="va">scan_f1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html">map_dfr</a></span><span class="op">(</span><span class="va">ths</span>, <span class="kw">function</span><span class="op">(</span><span class="va">t</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">cls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">PredictionBestModel</span><span class="op">$</span><span class="va">.pred_Churned</span> <span class="op">&gt;=</span> <span class="va">t</span>, <span class="st">"Churned"</span>, <span class="st">"Active"</span><span class="op">)</span>,</span>
<span>    levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Churned"</span>,<span class="st">"Active"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span></span>
<span>    threshold <span class="op">=</span> <span class="va">t</span>,</span>
<span>    f1 <span class="op">=</span> <span class="fu"><a href="https://yardstick.tidymodels.org/reference/f_meas.html">f_meas_vec</a></span><span class="op">(</span><span class="va">PredictionBestModel</span><span class="op">$</span><span class="va">Churn</span>, <span class="va">cls</span>, beta <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>    precision <span class="op">=</span> <span class="fu"><a href="https://yardstick.tidymodels.org/reference/precision.html">precision_vec</a></span><span class="op">(</span><span class="va">PredictionBestModel</span><span class="op">$</span><span class="va">Churn</span>, <span class="va">cls</span><span class="op">)</span>,</span>
<span>    recall <span class="op">=</span> <span class="fu"><a href="https://yardstick.tidymodels.org/reference/sens.html">sens_vec</a></span><span class="op">(</span><span class="va">PredictionBestModel</span><span class="op">$</span><span class="va">Churn</span>, <span class="va">cls</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Show the best threshold by F1</span></span>
<span><span class="va">best_thresh_f1</span> <span class="op">&lt;-</span> <span class="va">scan_f1</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_max</a></span><span class="op">(</span><span class="va">f1</span>, n <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">threshold</span><span class="op">)</span></span>
<span></span>
<span><span class="va">best_thresh_f1</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 0.7</code></pre>
</div>
</div>
<p>It appears that F1 peaks around t = 0.70. This increases our precision significantly while decreasing our recall.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">f1_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">scan_f1</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">threshold</span>, y <span class="op">=</span> <span class="va">f1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"steelblue"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"F1 Score Across Thresholds"</span>, y <span class="op">=</span> <span class="st">"F1 Score"</span>, x <span class="op">=</span> <span class="st">"Threshold"</span><span class="op">)</span></span>
<span></span>
<span> <span class="va">f1_plot2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">scan_f1</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">threshold</span>, y <span class="op">=</span> <span class="va">precision</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"steelblue"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Precision Score Across Thresholds"</span>, y <span class="op">=</span> <span class="st">"Precision Score"</span>, x <span class="op">=</span> <span class="st">"Threshold"</span><span class="op">)</span></span>
<span></span>
<span> <span class="va">f1_plot3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">scan_f1</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">threshold</span>, y <span class="op">=</span> <span class="va">recall</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"steelblue"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Recall Score Across Thresholds"</span>, y <span class="op">=</span> <span class="st">"Recall Score"</span>, x <span class="op">=</span> <span class="st">"Threshold"</span><span class="op">)</span></span>
<span> </span>
<span></span>
<span> <span class="va">f1_plot</span> <span class="op">|</span> <span class="op">(</span><span class="va">f1_plot2</span> <span class="op">/</span> <span class="va">f1_plot3</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="index_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Using 0.70 as a threshold, we achieve a more balanced model compared to the default threshold of 0.5, which we got after tuning our model for ROC AUC.</p>
<p>Precision is now at 0.35, and recall at 0.35.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">PredictionBestModel_f1</span> <span class="op">&lt;-</span> <span class="va">PredictionBestModel</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    .pred_class_opt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">.pred_Churned</span> <span class="op">&gt;=</span> <span class="va">best_thresh_f1</span>, <span class="st">"Churned"</span>, <span class="st">"Active"</span><span class="op">)</span>,</span>
<span>      levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Churned"</span>,<span class="st">"Active"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">cm_f1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://yardstick.tidymodels.org/reference/conf_mat.html">conf_mat</a></span><span class="op">(</span><span class="va">PredictionBestModel_f1</span>, truth <span class="op">=</span> <span class="va">Churn</span>, estimate <span class="op">=</span> <span class="va">.pred_class_opt</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cm_f1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>          Truth
Prediction Churned Active
   Churned       6     11
   Active       11    152</code></pre>
</div>
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">cm_f1</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead><tr class="header">
<th style="text-align: left;">.metric</th>
<th style="text-align: left;">.estimator</th>
<th style="text-align: right;">.estimate</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">accuracy</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.8777778</td>
</tr>
<tr class="even">
<td style="text-align: left;">kap</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.2854565</td>
</tr>
<tr class="odd">
<td style="text-align: left;">sens</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.3529412</td>
</tr>
<tr class="even">
<td style="text-align: left;">spec</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.9325153</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ppv</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.3529412</td>
</tr>
<tr class="even">
<td style="text-align: left;">npv</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.9325153</td>
</tr>
<tr class="odd">
<td style="text-align: left;">mcc</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.2854565</td>
</tr>
<tr class="even">
<td style="text-align: left;">j_index</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.2854565</td>
</tr>
<tr class="odd">
<td style="text-align: left;">bal_accuracy</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.6427283</td>
</tr>
<tr class="even">
<td style="text-align: left;">detection_prevalence</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.0944444</td>
</tr>
<tr class="odd">
<td style="text-align: left;">precision</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.3529412</td>
</tr>
<tr class="even">
<td style="text-align: left;">recall</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.3529412</td>
</tr>
<tr class="odd">
<td style="text-align: left;">f_meas</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.3529412</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p><strong>Compared to the previous model,</strong> <strong>this model is better at eliminating false churn cases</strong>. However, we are also missing out on more true positives due to the increased threshold for churn prediction.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">cm_f1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>          Truth
Prediction Churned Active
   Churned       6     11
   Active       11    152</code></pre>
</div>
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">cm</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>          Truth
Prediction Churned Active
   Churned       6     24
   Active       11    139</code></pre>
</div>
</div>
<p>We will refine further by changing weights.</p>
</section><section id="inverse-distance-weighting" class="level3"><h3 class="anchored" data-anchor-id="inverse-distance-weighting">Inverse Distance Weighting</h3>
<p>In our initial KNN model design, every neighbor were counted equally by default (weight_func = “rectangular”). This only takes into account the class of nearby points when predicting, ignoring distance. Inverse distance weighting (“inv”) makes KNN more sensitive to local structure, reducing the impact of “distant” neighbors by giving neighbors closer to the query point higher weight.</p>
<p>Simply using IDW with ROC, yielded higher recall than our first model.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ModelDesign_inv</span><span class="op">=</span><span class="fu">nearest_neighbor</span><span class="op">(</span>neighbors<span class="op">=</span><span class="fu">tune</span><span class="op">(</span><span class="op">)</span>, weight_func <span class="op">=</span> <span class="st">"inv"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>               <span class="fu">set_engine</span><span class="op">(</span><span class="st">"kknn"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>               <span class="fu">set_mode</span><span class="op">(</span><span class="st">"classification"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">TuneWFModel_inv</span><span class="op">=</span><span class="fu">workflow</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>            <span class="fu">add_recipe</span><span class="op">(</span><span class="va">Recipe</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>            <span class="fu">add_model</span><span class="op">(</span><span class="va">ModelDesign_inv</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">ParGrid</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>neighbors<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">15</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">FoldsForTuning</span><span class="op">=</span><span class="fu">vfold_cv</span><span class="op">(</span><span class="va">DataTrain</span>, v<span class="op">=</span><span class="fl">5</span>,</span>
<span>                        strata<span class="op">=</span><span class="va">Churn</span><span class="op">)</span></span>
<span></span>
<span><span class="va">TuneResults_inv</span><span class="op">=</span><span class="fu">tune_grid</span><span class="op">(</span><span class="va">TuneWFModel_inv</span>, resamples<span class="op">=</span><span class="va">FoldsForTuning</span>,</span>
<span>                      grid<span class="op">=</span><span class="va">ParGrid</span>, metrics<span class="op">=</span><span class="fu"><a href="https://yardstick.tidymodels.org/reference/metric_set.html">metric_set</a></span><span class="op">(</span><span class="va">roc_auc</span>, <span class="fu">yardstick</span><span class="fu">::</span><span class="va"><a href="https://yardstick.tidymodels.org/reference/accuracy.html">accuracy</a></span>, <span class="va">sens</span>, <span class="va">spec</span>, <span class="va">f_meas</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">BestHyperParameter_inv</span><span class="op">=</span><span class="fu">select_best</span><span class="op">(</span><span class="va">TuneResults_inv</span>, metric<span class="op">=</span><span class="st">"roc_auc"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">WFModelBest_inv</span><span class="op">=</span><span class="va">TuneWFModel_inv</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">finalize_workflow</span><span class="op">(</span><span class="va">BestHyperParameter_inv</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">fit</span><span class="op">(</span><span class="va">DataTrain</span><span class="op">)</span></span>
<span></span>
<span><span class="va">PredictionBestModel_inv</span><span class="op">=</span><span class="fu">augment</span><span class="op">(</span><span class="va">WFModelBest_inv</span>, <span class="va">DataTest</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cm_inv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://yardstick.tidymodels.org/reference/conf_mat.html">conf_mat</a></span><span class="op">(</span><span class="va">PredictionBestModel_inv</span>, truth<span class="op">=</span><span class="va">Churn</span>,</span>
<span>         estimate<span class="op">=</span><span class="va">.pred_class</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cm_inv</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>          Truth
Prediction Churned Active
   Churned       9     31
   Active        8    132</code></pre>
</div>
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">cm_inv</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead><tr class="header">
<th style="text-align: left;">.metric</th>
<th style="text-align: left;">.estimator</th>
<th style="text-align: right;">.estimate</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">accuracy</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.7833333</td>
</tr>
<tr class="even">
<td style="text-align: left;">kap</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.2112360</td>
</tr>
<tr class="odd">
<td style="text-align: left;">sens</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.5294118</td>
</tr>
<tr class="even">
<td style="text-align: left;">spec</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.8098160</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ppv</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.2250000</td>
</tr>
<tr class="even">
<td style="text-align: left;">npv</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.9428571</td>
</tr>
<tr class="odd">
<td style="text-align: left;">mcc</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.2386248</td>
</tr>
<tr class="even">
<td style="text-align: left;">j_index</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.3392277</td>
</tr>
<tr class="odd">
<td style="text-align: left;">bal_accuracy</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.6696139</td>
</tr>
<tr class="even">
<td style="text-align: left;">detection_prevalence</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.2222222</td>
</tr>
<tr class="odd">
<td style="text-align: left;">precision</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.2250000</td>
</tr>
<tr class="even">
<td style="text-align: left;">recall</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.5294118</td>
</tr>
<tr class="odd">
<td style="text-align: left;">f_meas</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.3157895</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>Setting the threshold to 0.70, again increased precision but decreased recall.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb44"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">scan_f1_inv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html">map_dfr</a></span><span class="op">(</span><span class="va">ths</span>, <span class="kw">function</span><span class="op">(</span><span class="va">t</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">cls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">PredictionBestModel_inv</span><span class="op">$</span><span class="va">.pred_Churned</span> <span class="op">&gt;=</span> <span class="va">t</span>, <span class="st">"Churned"</span>, <span class="st">"Active"</span><span class="op">)</span>,</span>
<span>    levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Churned"</span>,<span class="st">"Active"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span></span>
<span>    threshold <span class="op">=</span> <span class="va">t</span>,</span>
<span>    f1 <span class="op">=</span> <span class="fu"><a href="https://yardstick.tidymodels.org/reference/f_meas.html">f_meas_vec</a></span><span class="op">(</span><span class="va">PredictionBestModel_inv</span><span class="op">$</span><span class="va">Churn</span>, <span class="va">cls</span>, beta <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>    precision <span class="op">=</span> <span class="fu"><a href="https://yardstick.tidymodels.org/reference/precision.html">precision_vec</a></span><span class="op">(</span><span class="va">PredictionBestModel_inv</span><span class="op">$</span><span class="va">Churn</span>, <span class="va">cls</span><span class="op">)</span>,</span>
<span>    recall <span class="op">=</span> <span class="fu"><a href="https://yardstick.tidymodels.org/reference/sens.html">sens_vec</a></span><span class="op">(</span><span class="va">PredictionBestModel_inv</span><span class="op">$</span><span class="va">Churn</span>, <span class="va">cls</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="va">best_thresh_f1_inv</span> <span class="op">&lt;-</span> <span class="va">scan_f1_inv</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># Show the best threshold by F1</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_max</a></span><span class="op">(</span><span class="va">f1</span>, n <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">threshold</span><span class="op">)</span></span>
<span></span>
<span><span class="va">PredictionBestModel_f1_inv</span> <span class="op">&lt;-</span> <span class="va">PredictionBestModel_inv</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    .pred_class_opt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">.pred_Churned</span> <span class="op">&gt;=</span> <span class="va">best_thresh_f1_inv</span>, <span class="st">"Churned"</span>, <span class="st">"Active"</span><span class="op">)</span>,</span>
<span>      levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Churned"</span>,<span class="st">"Active"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">cm_inv_f1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://yardstick.tidymodels.org/reference/conf_mat.html">conf_mat</a></span><span class="op">(</span><span class="va">PredictionBestModel_f1_inv</span>, truth <span class="op">=</span> <span class="va">Churn</span>, estimate <span class="op">=</span> <span class="va">.pred_class_opt</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cm_inv_f1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>          Truth
Prediction Churned Active
   Churned       8     17
   Active        9    146</code></pre>
</div>
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">cm_inv_f1</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead><tr class="header">
<th style="text-align: left;">.metric</th>
<th style="text-align: left;">.estimator</th>
<th style="text-align: right;">.estimate</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">accuracy</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.8555556</td>
</tr>
<tr class="even">
<td style="text-align: left;">kap</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.3025335</td>
</tr>
<tr class="odd">
<td style="text-align: left;">sens</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.4705882</td>
</tr>
<tr class="even">
<td style="text-align: left;">spec</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.8957055</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ppv</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.3200000</td>
</tr>
<tr class="even">
<td style="text-align: left;">npv</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.9419355</td>
</tr>
<tr class="odd">
<td style="text-align: left;">mcc</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.3097504</td>
</tr>
<tr class="even">
<td style="text-align: left;">j_index</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.3662938</td>
</tr>
<tr class="odd">
<td style="text-align: left;">bal_accuracy</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.6831469</td>
</tr>
<tr class="even">
<td style="text-align: left;">detection_prevalence</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.1388889</td>
</tr>
<tr class="odd">
<td style="text-align: left;">precision</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.3200000</td>
</tr>
<tr class="even">
<td style="text-align: left;">recall</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.4705882</td>
</tr>
<tr class="odd">
<td style="text-align: left;">f_meas</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.3809524</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</section><section id="manhattan-distance-weighting" class="level3"><h3 class="anchored" data-anchor-id="manhattan-distance-weighting">Manhattan Distance Weighting</h3>
<p>Our previous models used Euclidean distance by default (dist_power = 2), which is sensitive to large differences in any single feature since squaring exaggerates outliers.</p>
<p>We can change this to Manhattan distance, which is more robust to high-dimensional and sparse data (like one-hot encoded variables), since it just adds absolute differences without squaring them.</p>
<p>Our dataset has lots of dummy variables and scaled numerics. Therefore, we may set our argument to favor Manhattan (dist_power = 1) to treat all feature differences more evenly.</p>
<p>Even without optimized for F1 score, Manhattan Distance Weighting gives us the highest recall and precision we obtained so far.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb47"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ModelDesign_man</span><span class="op">=</span><span class="fu">nearest_neighbor</span><span class="op">(</span>neighbors<span class="op">=</span><span class="fu">tune</span><span class="op">(</span><span class="op">)</span>, weight_func <span class="op">=</span> <span class="st">"inv"</span>, dist_power <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>               <span class="fu">set_engine</span><span class="op">(</span><span class="st">"kknn"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>               <span class="fu">set_mode</span><span class="op">(</span><span class="st">"classification"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">TuneWFModel_man</span><span class="op">=</span><span class="fu">workflow</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>            <span class="fu">add_recipe</span><span class="op">(</span><span class="va">Recipe</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>            <span class="fu">add_model</span><span class="op">(</span><span class="va">ModelDesign_man</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">ParGrid</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>neighbors<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">15</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">FoldsForTuning</span><span class="op">=</span><span class="fu">vfold_cv</span><span class="op">(</span><span class="va">DataTrain</span>, v<span class="op">=</span><span class="fl">5</span>,</span>
<span>                        strata<span class="op">=</span><span class="va">Churn</span><span class="op">)</span></span>
<span></span>
<span><span class="va">TuneResults_man</span><span class="op">=</span><span class="fu">tune_grid</span><span class="op">(</span><span class="va">TuneWFModel_man</span>, resamples<span class="op">=</span><span class="va">FoldsForTuning</span>,</span>
<span>                      grid<span class="op">=</span><span class="va">ParGrid</span>, metrics<span class="op">=</span><span class="fu"><a href="https://yardstick.tidymodels.org/reference/metric_set.html">metric_set</a></span><span class="op">(</span><span class="va">roc_auc</span>, <span class="fu">yardstick</span><span class="fu">::</span><span class="va"><a href="https://yardstick.tidymodels.org/reference/accuracy.html">accuracy</a></span>, <span class="va">sens</span>, <span class="va">spec</span>, <span class="va">f_meas</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">BestHyperParameter_man</span><span class="op">=</span><span class="fu">select_best</span><span class="op">(</span><span class="va">TuneResults_man</span>, metric<span class="op">=</span><span class="st">"roc_auc"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">WFModelBest_man</span><span class="op">=</span><span class="va">TuneWFModel_man</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">finalize_workflow</span><span class="op">(</span><span class="va">BestHyperParameter_man</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">fit</span><span class="op">(</span><span class="va">DataTrain</span><span class="op">)</span></span>
<span></span>
<span><span class="va">PredictionBestModel_man</span><span class="op">=</span><span class="fu">augment</span><span class="op">(</span><span class="va">WFModelBest_man</span>, <span class="va">DataTest</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cm_man</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://yardstick.tidymodels.org/reference/conf_mat.html">conf_mat</a></span><span class="op">(</span><span class="va">PredictionBestModel_man</span>, truth<span class="op">=</span><span class="va">Churn</span>,</span>
<span>         estimate<span class="op">=</span><span class="va">.pred_class</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cm_man</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>          Truth
Prediction Churned Active
   Churned       8     14
   Active        9    149</code></pre>
</div>
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb49"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">cm_man</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead><tr class="header">
<th style="text-align: left;">.metric</th>
<th style="text-align: left;">.estimator</th>
<th style="text-align: right;">.estimate</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">accuracy</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.8722222</td>
</tr>
<tr class="even">
<td style="text-align: left;">kap</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.3399235</td>
</tr>
<tr class="odd">
<td style="text-align: left;">sens</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.4705882</td>
</tr>
<tr class="even">
<td style="text-align: left;">spec</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.9141104</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ppv</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.3636364</td>
</tr>
<tr class="even">
<td style="text-align: left;">npv</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.9430380</td>
</tr>
<tr class="odd">
<td style="text-align: left;">mcc</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.3434781</td>
</tr>
<tr class="even">
<td style="text-align: left;">j_index</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.3846987</td>
</tr>
<tr class="odd">
<td style="text-align: left;">bal_accuracy</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.6923493</td>
</tr>
<tr class="even">
<td style="text-align: left;">detection_prevalence</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.1222222</td>
</tr>
<tr class="odd">
<td style="text-align: left;">precision</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.3636364</td>
</tr>
<tr class="even">
<td style="text-align: left;">recall</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.4705882</td>
</tr>
<tr class="odd">
<td style="text-align: left;">f_meas</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.4102564</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>After optimizing for the F1 score, we <strong>achieved 47% recall with 57% precision.</strong></p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb50"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Show the best threshold by F1</span></span>
<span><span class="va">scan_f1_man</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html">map_dfr</a></span><span class="op">(</span><span class="va">ths</span>, <span class="kw">function</span><span class="op">(</span><span class="va">t</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">cls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">PredictionBestModel_man</span><span class="op">$</span><span class="va">.pred_Churned</span> <span class="op">&gt;=</span> <span class="va">t</span>, <span class="st">"Churned"</span>, <span class="st">"Active"</span><span class="op">)</span>,</span>
<span>    levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Churned"</span>,<span class="st">"Active"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span></span>
<span>    threshold <span class="op">=</span> <span class="va">t</span>,</span>
<span>    f1 <span class="op">=</span> <span class="fu"><a href="https://yardstick.tidymodels.org/reference/f_meas.html">f_meas_vec</a></span><span class="op">(</span><span class="va">PredictionBestModel_man</span><span class="op">$</span><span class="va">Churn</span>, <span class="va">cls</span>, beta <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>    precision <span class="op">=</span> <span class="fu"><a href="https://yardstick.tidymodels.org/reference/precision.html">precision_vec</a></span><span class="op">(</span><span class="va">PredictionBestModel_man</span><span class="op">$</span><span class="va">Churn</span>, <span class="va">cls</span><span class="op">)</span>,</span>
<span>    recall <span class="op">=</span> <span class="fu"><a href="https://yardstick.tidymodels.org/reference/sens.html">sens_vec</a></span><span class="op">(</span><span class="va">PredictionBestModel_man</span><span class="op">$</span><span class="va">Churn</span>, <span class="va">cls</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="va">best_thresh_f1_man</span> <span class="op">&lt;-</span> <span class="va">scan_f1_man</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># Show the best threshold by F1</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_max</a></span><span class="op">(</span><span class="va">f1</span>, n <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">threshold</span><span class="op">)</span></span>
<span></span>
<span><span class="va">best_thresh_f1_man</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 0.62 0.63</code></pre>
</div>
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb52"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">PredictionBestModel_f1_man</span> <span class="op">&lt;-</span> <span class="va">PredictionBestModel_man</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    .pred_class_opt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">.pred_Churned</span> <span class="op">&gt;=</span> <span class="va">best_thresh_f1_man</span>, <span class="st">"Churned"</span>, <span class="st">"Active"</span><span class="op">)</span>,</span>
<span>      levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Churned"</span>,<span class="st">"Active"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">cm_man_f1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://yardstick.tidymodels.org/reference/conf_mat.html">conf_mat</a></span><span class="op">(</span><span class="va">PredictionBestModel_f1_man</span>, truth <span class="op">=</span> <span class="va">Churn</span>, estimate <span class="op">=</span> <span class="va">.pred_class_opt</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cm_man_f1</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead><tr class="header">
<th style="text-align: left;">.metric</th>
<th style="text-align: left;">.estimator</th>
<th style="text-align: right;">.estimate</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">accuracy</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.9166667</td>
</tr>
<tr class="even">
<td style="text-align: left;">kap</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.4710031</td>
</tr>
<tr class="odd">
<td style="text-align: left;">sens</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.4705882</td>
</tr>
<tr class="even">
<td style="text-align: left;">spec</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.9631902</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ppv</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.5714286</td>
</tr>
<tr class="even">
<td style="text-align: left;">npv</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.9457831</td>
</tr>
<tr class="odd">
<td style="text-align: left;">mcc</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.4736616</td>
</tr>
<tr class="even">
<td style="text-align: left;">j_index</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.4337784</td>
</tr>
<tr class="odd">
<td style="text-align: left;">bal_accuracy</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.7168892</td>
</tr>
<tr class="even">
<td style="text-align: left;">detection_prevalence</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.0777778</td>
</tr>
<tr class="odd">
<td style="text-align: left;">precision</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.5714286</td>
</tr>
<tr class="even">
<td style="text-align: left;">recall</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.4705882</td>
</tr>
<tr class="odd">
<td style="text-align: left;">f_meas</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.5161290</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</section></section><section id="conclusion" class="level2" data-number="7"><h2 data-number="7" class="anchored" data-anchor-id="conclusion">
<span class="header-section-number">7</span> Conclusion</h2>
<p>Our final KNN model predicts 47% of all churn cases correctly with 57% precision.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb53"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">cm_man_f1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>          Truth
Prediction Churned Active
   Churned       8      6
   Active        9    157</code></pre>
</div>
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb55"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">cm_man_f1</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="kable-table">
<table class="caption-top table table-sm table-striped small">
<thead><tr class="header">
<th style="text-align: left;">.metric</th>
<th style="text-align: left;">.estimator</th>
<th style="text-align: right;">.estimate</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">accuracy</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.9166667</td>
</tr>
<tr class="even">
<td style="text-align: left;">kap</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.4710031</td>
</tr>
<tr class="odd">
<td style="text-align: left;">sens</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.4705882</td>
</tr>
<tr class="even">
<td style="text-align: left;">spec</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.9631902</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ppv</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.5714286</td>
</tr>
<tr class="even">
<td style="text-align: left;">npv</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.9457831</td>
</tr>
<tr class="odd">
<td style="text-align: left;">mcc</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.4736616</td>
</tr>
<tr class="even">
<td style="text-align: left;">j_index</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.4337784</td>
</tr>
<tr class="odd">
<td style="text-align: left;">bal_accuracy</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.7168892</td>
</tr>
<tr class="even">
<td style="text-align: left;">detection_prevalence</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.0777778</td>
</tr>
<tr class="odd">
<td style="text-align: left;">precision</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.5714286</td>
</tr>
<tr class="even">
<td style="text-align: left;">recall</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.4705882</td>
</tr>
<tr class="odd">
<td style="text-align: left;">f_meas</td>
<td style="text-align: left;">binary</td>
<td style="text-align: right;">0.5161290</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>Through several optimizations, we transformed KNN into a model that provides practical business value for churn prediction. The initial version, using Euclidean distance and equal neighbor weighting, was prone to misclassifying churners because the majority “Active” class dominated.</p>
<p>By introducing <strong>inverse distance weighting</strong>, the model became more sensitive to customers whose behavior closely resembled churners, improving its ability to detect at-risk users. Switching to <strong>Manhattan distance</strong> further improved results by better handling the many categorical (dummy) features in our dataset, allowing the model to differentiate churners more effectively. Finally, instead of relying on the default 0.5 probability cutoff, we optimized the <strong>decision threshold</strong> for the F1 score, which balanced the need to catch more churners (recall) with the need to reduce false alarms (precision).</p>
<p>Together, these changes yielded a model that can more reliably flag customers with genuine churn risk, enabling more targeted and cost-effective retention campaigns.</p>
<section id="next-steps" class="level3"><h3 class="anchored" data-anchor-id="next-steps">Next Steps</h3>
<p>Looking ahead, we recommend benchmarking this improved KNN against <strong>tree-based methods such as Random Forest</strong>. These algorithms often outperform KNN on imbalanced, high-dimensional data and may further increase recall without sacrificing precision. Incorporating <strong>cost-sensitive evaluation</strong> (penalizing missed churns more heavily) and <strong>feature engineering</strong> to capture behavioral trends (e.g., declining engagement over time) would also align the modeling process more closely with business objectives. This will ensure that our churn detection framework continues to evolve into a robust, actionable tool for customer retention strategy.</p>


<!-- -->

</section></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb56" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Churn Prediction with Tidymodels - Part 1: K-Nearest Neighbors"</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> Ceren Unal</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="an">categories:</span><span class="co"> [classification, exploratory data analysis]</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a><span class="an">image:</span><span class="co"> image-woman-watching-tv.png</span></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a><span class="an">description:</span><span class="co"> The first part of the Churn Prediction project explores the customer data set and builds a baseline model using the K-Nearest Neighbors algorithm.</span></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a><span class="an">toc:</span><span class="co"> true</span></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a><span class="an">toc-title:</span><span class="co"> Content</span></span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a><span class="an">toc-location:</span><span class="co"> right</span></span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a><span class="an">number-sections:</span><span class="co"> true</span></span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a><span class="an">number-depth:</span><span class="co"> 2 </span></span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a><span class="an">smooth-scroll:</span><span class="co"> true</span></span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a><span class="an">df-print:</span><span class="co"> kable</span></span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a><span class="an">code-fold:</span><span class="co"> true</span></span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a><span class="an">code-tools:</span><span class="co"> true</span></span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a><span class="an">code-overflow:</span><span class="co"> wrap </span></span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a><span class="an">code-block-bg:</span><span class="co"> true</span></span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a><span class="an">code-block-border-left:</span><span class="co"> "#31BAE9"</span></span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a><span class="an">highlight-style:</span><span class="co"> pygments</span></span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a><span class="an">code-link:</span><span class="co"> true</span></span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span></span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a><span class="co">  warning: false</span></span>
<span id="cb56-23"><a href="#cb56-23" aria-hidden="true" tabindex="-1"></a><span class="co">  message: false</span></span>
<span id="cb56-24"><a href="#cb56-24" aria-hidden="true" tabindex="-1"></a><span class="co">#comments:</span></span>
<span id="cb56-25"><a href="#cb56-25" aria-hidden="true" tabindex="-1"></a><span class="co">#  hypothesis: true</span></span>
<span id="cb56-26"><a href="#cb56-26" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb56-27"><a href="#cb56-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-28"><a href="#cb56-28" aria-hidden="true" tabindex="-1"></a>*This study aims to develop a customer churn prediction model for the fictional streaming service Skystream, using a synthetic dataset.*</span>
<span id="cb56-29"><a href="#cb56-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-30"><a href="#cb56-30" aria-hidden="true" tabindex="-1"></a>Skystream is an emerging U.S.-based platform currently focusing its marketing efforts across eight states. The analysis employs a K-Nearest Neighbors (KNN) supervised learning algorithm to predict customer churn based on demographic and behavioral attributes within the dataset.</span>
<span id="cb56-31"><a href="#cb56-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-32"><a href="#cb56-32" aria-hidden="true" tabindex="-1"></a><span class="fu">## Load Packages &amp; Data</span></span>
<span id="cb56-33"><a href="#cb56-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-34"><a href="#cb56-34" aria-hidden="true" tabindex="-1"></a>We will use the **Tidyverse** package for data processing. At first glance, the dataset appears to be in a tidy format, with each variable represented as a column and each observation as a row.</span>
<span id="cb56-35"><a href="#cb56-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-38"><a href="#cb56-38" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-39"><a href="#cb56-39" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb56-40"><a href="#cb56-40" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DataExplorer)</span>
<span id="cb56-41"><a href="#cb56-41" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb56-42"><a href="#cb56-42" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(GGally)</span>
<span id="cb56-43"><a href="#cb56-43" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(fastDummies)</span>
<span id="cb56-44"><a href="#cb56-44" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(snakecase)</span>
<span id="cb56-45"><a href="#cb56-45" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span>
<span id="cb56-46"><a href="#cb56-46" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(themis)</span>
<span id="cb56-47"><a href="#cb56-47" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(yardstick)</span>
<span id="cb56-48"><a href="#cb56-48" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb56-49"><a href="#cb56-49" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survminer)</span>
<span id="cb56-50"><a href="#cb56-50" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(paletteer)</span>
<span id="cb56-51"><a href="#cb56-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-52"><a href="#cb56-52" aria-hidden="true" tabindex="-1"></a>skystream <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="at">file =</span> <span class="st">"skystream.csv"</span>)</span>
<span id="cb56-53"><a href="#cb56-53" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-54"><a href="#cb56-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-55"><a href="#cb56-55" aria-hidden="true" tabindex="-1"></a>We have 900 observations and 14 variables. Several of these numeric and character variables should be converted to factors for analysis purposes. We will want to see the distribution of demographic and behavioral characteristics in our customer base.</span>
<span id="cb56-56"><a href="#cb56-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-57"><a href="#cb56-57" aria-hidden="true" tabindex="-1"></a>We also have 883 missing values that we need to look into. The majority of the missing values are in the CancelDate variable, which is expected as active users are not meant to have a cancel date. The remaining 2 missing values are in the JoinDate variable.</span>
<span id="cb56-58"><a href="#cb56-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-61"><a href="#cb56-61" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-62"><a href="#cb56-62" aria-hidden="true" tabindex="-1"></a>skimr<span class="sc">::</span><span class="fu">skim</span>(skystream)</span>
<span id="cb56-63"><a href="#cb56-63" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-64"><a href="#cb56-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-65"><a href="#cb56-65" aria-hidden="true" tabindex="-1"></a>Two users have 4 NumberMonthsActive but not JoinDate or CancelDate, hence we aren't able to trace back from CancelDate to fill in their JoinDate. However, we aren't interested in JoinDate as a variable in our churn model so we not be removing these users with NA values from our data set.</span>
<span id="cb56-66"><a href="#cb56-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-69"><a href="#cb56-69" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-70"><a href="#cb56-70" aria-hidden="true" tabindex="-1"></a>skystream <span class="sc">%&gt;%</span></span>
<span id="cb56-71"><a href="#cb56-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(JoinDate))</span>
<span id="cb56-72"><a href="#cb56-72" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-73"><a href="#cb56-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-74"><a href="#cb56-74" aria-hidden="true" tabindex="-1"></a>Checking for unique values in each categorical variable, we find that the genre Drama is coded as Dramas for some observations, we need to recode these.</span>
<span id="cb56-75"><a href="#cb56-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-78"><a href="#cb56-78" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-79"><a href="#cb56-79" aria-hidden="true" tabindex="-1"></a>skystream <span class="sc">%&gt;%</span></span>
<span id="cb56-80"><a href="#cb56-80" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">where</span>(<span class="sc">~</span> <span class="fu">is.character</span>(.x) <span class="sc">||</span> <span class="fu">is.factor</span>(.x))) <span class="sc">%&gt;%</span></span>
<span id="cb56-81"><a href="#cb56-81" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(unique)</span>
<span id="cb56-82"><a href="#cb56-82" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-83"><a href="#cb56-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-84"><a href="#cb56-84" aria-hidden="true" tabindex="-1"></a><span class="fu">## Data Wrangling</span></span>
<span id="cb56-85"><a href="#cb56-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-86"><a href="#cb56-86" aria-hidden="true" tabindex="-1"></a>We create a new variable for Churn based on whether the user has a CancelDate or not and clean up our Genre variable.</span>
<span id="cb56-87"><a href="#cb56-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-90"><a href="#cb56-90" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-91"><a href="#cb56-91" aria-hidden="true" tabindex="-1"></a>skystream <span class="ot">&lt;-</span> skystream <span class="sc">%&gt;%</span></span>
<span id="cb56-92"><a href="#cb56-92" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb56-93"><a href="#cb56-93" aria-hidden="true" tabindex="-1"></a>    <span class="at">Churn =</span> <span class="fu">if_else</span>(<span class="fu">is.na</span>(CancelDate), <span class="dv">0</span>L, <span class="dv">1</span>L) <span class="co">#return 1 if there is a CancelDate</span></span>
<span id="cb56-94"><a href="#cb56-94" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb56-95"><a href="#cb56-95" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(Churn, <span class="at">.after =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> <span class="co">#position it after column 1 </span></span>
<span id="cb56-96"><a href="#cb56-96" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Genre =</span> <span class="fu">recode</span>(Genre, <span class="st">"Dramas"</span> <span class="ot">=</span> <span class="st">"Drama"</span>), <span class="co">#replace Dramas with Drama</span></span>
<span id="cb56-97"><a href="#cb56-97" aria-hidden="true" tabindex="-1"></a>         <span class="at">SubscriptionTier =</span> <span class="fu">factor</span>(SubscriptionTier,</span>
<span id="cb56-98"><a href="#cb56-98" aria-hidden="true" tabindex="-1"></a>                              <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Ad-Supported"</span>,<span class="st">"Basic"</span>, <span class="st">"Premium"</span>, <span class="st">"Family"</span>), <span class="co">#relevel tiers</span></span>
<span id="cb56-99"><a href="#cb56-99" aria-hidden="true" tabindex="-1"></a>                              <span class="at">ordered =</span> <span class="cn">TRUE</span>)) </span>
<span id="cb56-100"><a href="#cb56-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-101"><a href="#cb56-101" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-102"><a href="#cb56-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-103"><a href="#cb56-103" aria-hidden="true" tabindex="-1"></a><span class="fu">## Data Exploration</span></span>
<span id="cb56-104"><a href="#cb56-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-105"><a href="#cb56-105" aria-hidden="true" tabindex="-1"></a>There are users from 9 states in the data set, equally distributed, minus the AZ user base which seems to be extremely low. There might be a mistake in the records.</span>
<span id="cb56-106"><a href="#cb56-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-107"><a href="#cb56-107" aria-hidden="true" tabindex="-1"></a>Female users form the majority of the user base, and the device preference is mostly mobile. Basic is the most preferred subscription tier, while Ad-Support is the least despite being the cheapest option. Users seem willing to pay more for the ad-free experience.</span>
<span id="cb56-108"><a href="#cb56-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-111"><a href="#cb56-111" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-112"><a href="#cb56-112" aria-hidden="true" tabindex="-1"></a>device_plot <span class="ot">&lt;-</span> skystream <span class="sc">%&gt;%</span></span>
<span id="cb56-113"><a href="#cb56-113" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">fct_infreq</span>(DevicePreference))) <span class="sc">+</span></span>
<span id="cb56-114"><a href="#cb56-114" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">fill =</span> <span class="st">"#7C873EFF"</span>) <span class="sc">+</span></span>
<span id="cb56-115"><a href="#cb56-115" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Device Preference"</span>, <span class="at">x =</span> <span class="st">"Device"</span>, <span class="at">y =</span> <span class="st">"Count"</span>) <span class="sc">+</span></span>
<span id="cb56-116"><a href="#cb56-116" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() </span>
<span id="cb56-117"><a href="#cb56-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-118"><a href="#cb56-118" aria-hidden="true" tabindex="-1"></a>state_plot <span class="ot">&lt;-</span> skystream <span class="sc">%&gt;%</span></span>
<span id="cb56-119"><a href="#cb56-119" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">fct_infreq</span>(State))) <span class="sc">+</span></span>
<span id="cb56-120"><a href="#cb56-120" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">fill =</span> <span class="st">"#DB4743FF"</span>) <span class="sc">+</span></span>
<span id="cb56-121"><a href="#cb56-121" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"State"</span>, <span class="at">x =</span> <span class="st">"State"</span>, <span class="at">y =</span> <span class="st">"Count"</span>) <span class="sc">+</span></span>
<span id="cb56-122"><a href="#cb56-122" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() </span>
<span id="cb56-123"><a href="#cb56-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-124"><a href="#cb56-124" aria-hidden="true" tabindex="-1"></a>gender_plot <span class="ot">&lt;-</span> skystream <span class="sc">%&gt;%</span></span>
<span id="cb56-125"><a href="#cb56-125" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">fct_infreq</span>(Gender))) <span class="sc">+</span></span>
<span id="cb56-126"><a href="#cb56-126" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">fill =</span> <span class="st">"#F5AF4DFF"</span>) <span class="sc">+</span></span>
<span id="cb56-127"><a href="#cb56-127" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Gender"</span>, <span class="at">x =</span> <span class="st">"Gender"</span>, <span class="at">y =</span> <span class="st">"Count"</span>) <span class="sc">+</span></span>
<span id="cb56-128"><a href="#cb56-128" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() </span>
<span id="cb56-129"><a href="#cb56-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-130"><a href="#cb56-130" aria-hidden="true" tabindex="-1"></a>tier_plot <span class="ot">&lt;-</span> skystream <span class="sc">%&gt;%</span></span>
<span id="cb56-131"><a href="#cb56-131" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">fct_infreq</span>(SubscriptionTier))) <span class="sc">+</span></span>
<span id="cb56-132"><a href="#cb56-132" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">fill =</span> <span class="st">"#5495CFFF"</span>) <span class="sc">+</span></span>
<span id="cb56-133"><a href="#cb56-133" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Subscription Tier"</span>, <span class="at">x =</span> <span class="st">"Tier"</span>, <span class="at">y =</span> <span class="st">"Count"</span>) <span class="sc">+</span></span>
<span id="cb56-134"><a href="#cb56-134" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() </span>
<span id="cb56-135"><a href="#cb56-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-136"><a href="#cb56-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-137"><a href="#cb56-137" aria-hidden="true" tabindex="-1"></a>patch_plot <span class="ot">&lt;-</span> state_plot <span class="sc">+</span> gender_plot <span class="sc">+</span> tier_plot <span class="sc">+</span> device_plot </span>
<span id="cb56-138"><a href="#cb56-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-139"><a href="#cb56-139" aria-hidden="true" tabindex="-1"></a>patch_plot <span class="sc">+</span> <span class="fu">plot_annotation</span>(</span>
<span id="cb56-140"><a href="#cb56-140" aria-hidden="true" tabindex="-1"></a>  <span class="at">title =</span> <span class="st">'User Characteristics'</span></span>
<span id="cb56-141"><a href="#cb56-141" aria-hidden="true" tabindex="-1"></a>) <span class="sc">&amp;</span></span>
<span id="cb56-142"><a href="#cb56-142" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb56-143"><a href="#cb56-143" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>) </span>
<span id="cb56-144"><a href="#cb56-144" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb56-145"><a href="#cb56-145" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-146"><a href="#cb56-146" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-147"><a href="#cb56-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-148"><a href="#cb56-148" aria-hidden="true" tabindex="-1"></a>Age distribution is right skewed, with the majority of our user base falling between ages 20 to 40.</span>
<span id="cb56-149"><a href="#cb56-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-152"><a href="#cb56-152" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-153"><a href="#cb56-153" aria-hidden="true" tabindex="-1"></a>skystream <span class="sc">%&gt;%</span> </span>
<span id="cb56-154"><a href="#cb56-154" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(Age)) <span class="sc">+</span></span>
<span id="cb56-155"><a href="#cb56-155" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(</span>
<span id="cb56-156"><a href="#cb56-156" aria-hidden="true" tabindex="-1"></a>    <span class="at">bins =</span> <span class="dv">9</span>,  </span>
<span id="cb56-157"><a href="#cb56-157" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"#5495CFFF"</span>,</span>
<span id="cb56-158"><a href="#cb56-158" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"white"</span></span>
<span id="cb56-159"><a href="#cb56-159" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb56-160"><a href="#cb56-160" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Age Distribution"</span>) <span class="sc">+</span></span>
<span id="cb56-161"><a href="#cb56-161" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">14</span>) <span class="sc">+</span></span>
<span id="cb56-162"><a href="#cb56-162" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb56-163"><a href="#cb56-163" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb56-164"><a href="#cb56-164" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major.x =</span> <span class="fu">element_blank</span>()</span>
<span id="cb56-165"><a href="#cb56-165" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb56-166"><a href="#cb56-166" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-167"><a href="#cb56-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-168"><a href="#cb56-168" aria-hidden="true" tabindex="-1"></a>Genre preferences are quite evenly distributed within the user base.</span>
<span id="cb56-169"><a href="#cb56-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-172"><a href="#cb56-172" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-173"><a href="#cb56-173" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb56-174"><a href="#cb56-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-175"><a href="#cb56-175" aria-hidden="true" tabindex="-1"></a>skystream <span class="sc">%&gt;%</span></span>
<span id="cb56-176"><a href="#cb56-176" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">fct_infreq</span>(Genre))) <span class="sc">+</span></span>
<span id="cb56-177"><a href="#cb56-177" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">fill =</span> <span class="st">"#5495CFFF"</span>) <span class="sc">+</span></span>
<span id="cb56-178"><a href="#cb56-178" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Genre Preference Distribution"</span>, <span class="at">x =</span> <span class="st">"Genre"</span>, <span class="at">y =</span> <span class="st">"Count"</span>) <span class="sc">+</span></span>
<span id="cb56-179"><a href="#cb56-179" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">14</span>) <span class="sc">+</span></span>
<span id="cb56-180"><a href="#cb56-180" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb56-181"><a href="#cb56-181" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb56-182"><a href="#cb56-182" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major.x =</span> <span class="fu">element_blank</span>()</span>
<span id="cb56-183"><a href="#cb56-183" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb56-184"><a href="#cb56-184" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-185"><a href="#cb56-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-186"><a href="#cb56-186" aria-hidden="true" tabindex="-1"></a>Tiers by State reveals an interesting pattern. In TX and WA, Premium tier dominates while in CA and GA the leading tier is Family. CO and FL subscribe mainly to Basic tier, and IL and NY to Ad-Supported.</span>
<span id="cb56-187"><a href="#cb56-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-190"><a href="#cb56-190" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-191"><a href="#cb56-191" aria-hidden="true" tabindex="-1"></a>skystream <span class="sc">%&gt;%</span> </span>
<span id="cb56-192"><a href="#cb56-192" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> State, <span class="at">fill =</span> SubscriptionTier)) <span class="sc">+</span></span>
<span id="cb56-193"><a href="#cb56-193" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>() <span class="sc">+</span></span>
<span id="cb56-194"><a href="#cb56-194" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb56-195"><a href="#cb56-195" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Subscription Tiers by State"</span>,</span>
<span id="cb56-196"><a href="#cb56-196" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"State"</span>, <span class="at">y =</span> <span class="st">"Subscribers"</span>, <span class="at">fill =</span> <span class="st">"Tier"</span></span>
<span id="cb56-197"><a href="#cb56-197" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb56-198"><a href="#cb56-198" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">13</span>) <span class="sc">+</span></span>
<span id="cb56-199"><a href="#cb56-199" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_paletteer_d</span>(<span class="st">"nationalparkcolors::Badlands"</span>) <span class="sc">+</span></span>
<span id="cb56-200"><a href="#cb56-200" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>), </span>
<span id="cb56-201"><a href="#cb56-201" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb56-202"><a href="#cb56-202" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">16</span>))</span>
<span id="cb56-203"><a href="#cb56-203" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb56-204"><a href="#cb56-204" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-205"><a href="#cb56-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-206"><a href="#cb56-206" aria-hidden="true" tabindex="-1"></a>There is strong correlation between AvgWatchHoursPerMonth, AvgSessionLength, which seems logical in that users who spend more time on the platform per session, also spend more hours watching movies per month. It may also signal that increasing session duration is positive user behavior, instead of a negative behavior such as unproductive scrolling and browsing for content.</span>
<span id="cb56-207"><a href="#cb56-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-208"><a href="#cb56-208" aria-hidden="true" tabindex="-1"></a>No strong correlation between continious variables and Churn.</span>
<span id="cb56-209"><a href="#cb56-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-212"><a href="#cb56-212" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-213"><a href="#cb56-213" aria-hidden="true" tabindex="-1"></a>skystream <span class="sc">%&gt;%</span></span>
<span id="cb56-214"><a href="#cb56-214" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Age, NumberMonthsActive, AvgWatchHoursPerMonth, AvgSessionLength, Churn) <span class="sc">%&gt;%</span></span>
<span id="cb56-215"><a href="#cb56-215" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggpairs</span>()</span>
<span id="cb56-216"><a href="#cb56-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-217"><a href="#cb56-217" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-218"><a href="#cb56-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-219"><a href="#cb56-219" aria-hidden="true" tabindex="-1"></a>No strong correlation between categorical variables and Churn.</span>
<span id="cb56-220"><a href="#cb56-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-223"><a href="#cb56-223" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-224"><a href="#cb56-224" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rcompanion)</span>
<span id="cb56-225"><a href="#cb56-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-226"><a href="#cb56-226" aria-hidden="true" tabindex="-1"></a><span class="fu">cramerV</span>(<span class="fu">table</span>(skystream<span class="sc">$</span>Churn, skystream<span class="sc">$</span>Gender))        </span>
<span id="cb56-227"><a href="#cb56-227" aria-hidden="true" tabindex="-1"></a><span class="fu">cramerV</span>(<span class="fu">table</span>(skystream<span class="sc">$</span>Churn, skystream<span class="sc">$</span>Genre))          </span>
<span id="cb56-228"><a href="#cb56-228" aria-hidden="true" tabindex="-1"></a><span class="fu">cramerV</span>(<span class="fu">table</span>(skystream<span class="sc">$</span>Churn, skystream<span class="sc">$</span>SubscriptionTier)) </span>
<span id="cb56-229"><a href="#cb56-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-230"><a href="#cb56-230" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-231"><a href="#cb56-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-232"><a href="#cb56-232" aria-hidden="true" tabindex="-1"></a>Less than 10% of users have churned, out of 900 users.</span>
<span id="cb56-233"><a href="#cb56-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-236"><a href="#cb56-236" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-237"><a href="#cb56-237" aria-hidden="true" tabindex="-1"></a>skystream <span class="sc">%&gt;%</span></span>
<span id="cb56-238"><a href="#cb56-238" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(Churn) <span class="sc">%&gt;%</span></span>
<span id="cb56-239"><a href="#cb56-239" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prop =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n)) <span class="sc">%&gt;%</span></span>
<span id="cb56-240"><a href="#cb56-240" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">factor</span>(Churn), <span class="at">y =</span> n, <span class="at">fill =</span> <span class="fu">factor</span>(Churn))) <span class="sc">+</span></span>
<span id="cb56-241"><a href="#cb56-241" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>() <span class="sc">+</span></span>
<span id="cb56-242"><a href="#cb56-242" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> scales<span class="sc">::</span><span class="fu">percent</span>(prop, <span class="at">accuracy =</span> <span class="dv">1</span>)),</span>
<span id="cb56-243"><a href="#cb56-243" aria-hidden="true" tabindex="-1"></a>            <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb56-244"><a href="#cb56-244" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"0"</span> <span class="ot">=</span> <span class="st">"grey70"</span>, <span class="st">"1"</span> <span class="ot">=</span> <span class="st">"#DB4743FF"</span>)) <span class="sc">+</span></span>
<span id="cb56-245"><a href="#cb56-245" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(<span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"0"</span> <span class="ot">=</span> <span class="st">"No"</span>, <span class="st">"1"</span> <span class="ot">=</span> <span class="st">"Yes"</span>)) <span class="sc">+</span></span>
<span id="cb56-246"><a href="#cb56-246" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Churn Status"</span>,</span>
<span id="cb56-247"><a href="#cb56-247" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Proportion of Users"</span>,</span>
<span id="cb56-248"><a href="#cb56-248" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Churn vs No Churn with Percentages"</span>,</span>
<span id="cb56-249"><a href="#cb56-249" aria-hidden="true" tabindex="-1"></a>       <span class="at">fill =</span> <span class="st">"Churn"</span>) <span class="sc">+</span></span>
<span id="cb56-250"><a href="#cb56-250" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="st">"none"</span>) </span>
<span id="cb56-251"><a href="#cb56-251" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-252"><a href="#cb56-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-253"><a href="#cb56-253" aria-hidden="true" tabindex="-1"></a>There is a significant drop among users after 9 months.</span>
<span id="cb56-254"><a href="#cb56-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-257"><a href="#cb56-257" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-258"><a href="#cb56-258" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(NumberMonthsActive, Churn) <span class="sc">~</span> <span class="dv">1</span>, skystream)</span>
<span id="cb56-259"><a href="#cb56-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-260"><a href="#cb56-260" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsurvplot</span>(fit, <span class="at">conf.int =</span> <span class="cn">TRUE</span>,</span>
<span id="cb56-261"><a href="#cb56-261" aria-hidden="true" tabindex="-1"></a>           <span class="at">xlab =</span> <span class="st">"Months"</span>,</span>
<span id="cb56-262"><a href="#cb56-262" aria-hidden="true" tabindex="-1"></a>           <span class="at">ylab =</span> <span class="st">"Proportion Still Active"</span>,</span>
<span id="cb56-263"><a href="#cb56-263" aria-hidden="true" tabindex="-1"></a>           <span class="at">title =</span> <span class="st">"User Retention Curve"</span>)</span>
<span id="cb56-264"><a href="#cb56-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-265"><a href="#cb56-265" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-266"><a href="#cb56-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-267"><a href="#cb56-267" aria-hidden="true" tabindex="-1"></a>The 9 month retention is similar across genders.</span>
<span id="cb56-268"><a href="#cb56-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-271"><a href="#cb56-271" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-272"><a href="#cb56-272" aria-hidden="true" tabindex="-1"></a>fit_gender <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(NumberMonthsActive, Churn) <span class="sc">~</span> Gender, skystream)</span>
<span id="cb56-273"><a href="#cb56-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-274"><a href="#cb56-274" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsurvplot</span>(fit_gender, skystream,</span>
<span id="cb56-275"><a href="#cb56-275" aria-hidden="true" tabindex="-1"></a>           <span class="at">xlab =</span> <span class="st">"Months"</span>,</span>
<span id="cb56-276"><a href="#cb56-276" aria-hidden="true" tabindex="-1"></a>           <span class="at">ylab =</span> <span class="st">"Proportion Still Active"</span>,</span>
<span id="cb56-277"><a href="#cb56-277" aria-hidden="true" tabindex="-1"></a>           <span class="at">title =</span> <span class="st">"User Retention Curve by Gender"</span>)</span>
<span id="cb56-278"><a href="#cb56-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-279"><a href="#cb56-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-280"><a href="#cb56-280" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-281"><a href="#cb56-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-282"><a href="#cb56-282" aria-hidden="true" tabindex="-1"></a>Horror and Documentary fans show significant loss in retention over time. They might be losing interest due to a lack of new content in these genres.</span>
<span id="cb56-283"><a href="#cb56-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-286"><a href="#cb56-286" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-287"><a href="#cb56-287" aria-hidden="true" tabindex="-1"></a>fit_genre <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(NumberMonthsActive, Churn) <span class="sc">~</span> Genre, skystream)</span>
<span id="cb56-288"><a href="#cb56-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-289"><a href="#cb56-289" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsurvplot</span>(fit_genre, skystream,</span>
<span id="cb56-290"><a href="#cb56-290" aria-hidden="true" tabindex="-1"></a>           <span class="at">xlab =</span> <span class="st">"Months"</span>,</span>
<span id="cb56-291"><a href="#cb56-291" aria-hidden="true" tabindex="-1"></a>           <span class="at">ylab =</span> <span class="st">"Proportion Still Active"</span>,</span>
<span id="cb56-292"><a href="#cb56-292" aria-hidden="true" tabindex="-1"></a>           <span class="at">title =</span> <span class="st">"User Retention Curve by Genre"</span>)</span>
<span id="cb56-293"><a href="#cb56-293" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-294"><a href="#cb56-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-295"><a href="#cb56-295" aria-hidden="true" tabindex="-1"></a>Retention is much stronger in higher tiers. Ad-supported and Basic seem to lose steam around 6 months.</span>
<span id="cb56-296"><a href="#cb56-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-299"><a href="#cb56-299" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-300"><a href="#cb56-300" aria-hidden="true" tabindex="-1"></a>fit_tier <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(NumberMonthsActive, Churn) <span class="sc">~</span> SubscriptionTier, skystream)</span>
<span id="cb56-301"><a href="#cb56-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-302"><a href="#cb56-302" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsurvplot</span>(fit_tier, skystream,</span>
<span id="cb56-303"><a href="#cb56-303" aria-hidden="true" tabindex="-1"></a>           <span class="at">xlab =</span> <span class="st">"Months"</span>,</span>
<span id="cb56-304"><a href="#cb56-304" aria-hidden="true" tabindex="-1"></a>           <span class="at">ylab =</span> <span class="st">"Proportion Still Active"</span>,</span>
<span id="cb56-305"><a href="#cb56-305" aria-hidden="true" tabindex="-1"></a>           <span class="at">title =</span> <span class="st">"User Retention Curve by Tier"</span>)</span>
<span id="cb56-306"><a href="#cb56-306" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-307"><a href="#cb56-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-308"><a href="#cb56-308" aria-hidden="true" tabindex="-1"></a><span class="fu">## Data Preparation for KNN</span></span>
<span id="cb56-309"><a href="#cb56-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-310"><a href="#cb56-310" aria-hidden="true" tabindex="-1"></a>After initial data exploration, we prepare data for KNN. We ensure that all continuous variables are numeric and we drop the variables that we will not be using in our model. RevenueYTD is dropped as it would be reduntant when we have both SubscriptionTier and NumberMonthsActive in the model, which directly determine this 3rd variable.</span>
<span id="cb56-311"><a href="#cb56-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-312"><a href="#cb56-312" aria-hidden="true" tabindex="-1"></a>We convert the Churn variable, which indicates whether a customer has churned, into a factor so it can be treated as a categorical classification outcome.</span>
<span id="cb56-313"><a href="#cb56-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-314"><a href="#cb56-314" aria-hidden="true" tabindex="-1"></a>The categorical variables are recoded as dummy variables so KNN can compute distance across categories.</span>
<span id="cb56-315"><a href="#cb56-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-318"><a href="#cb56-318" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-319"><a href="#cb56-319" aria-hidden="true" tabindex="-1"></a><span class="co"># Define columns by role/type</span></span>
<span id="cb56-320"><a href="#cb56-320" aria-hidden="true" tabindex="-1"></a>num_cols  <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"NumberMonthsActive"</span>, <span class="st">"AvgSessionLength"</span>, <span class="st">"Age"</span>,</span>
<span id="cb56-321"><a href="#cb56-321" aria-hidden="true" tabindex="-1"></a>               <span class="st">"MonthsSinceLastActivity"</span>, <span class="st">"AvgWatchHoursPerMonth"</span>)</span>
<span id="cb56-322"><a href="#cb56-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-323"><a href="#cb56-323" aria-hidden="true" tabindex="-1"></a>cat_cols  <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"SubscriptionTier"</span>, <span class="st">"Genre"</span>, <span class="st">"State"</span>, <span class="st">"Gender"</span>, <span class="st">"DevicePreference"</span>)</span>
<span id="cb56-324"><a href="#cb56-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-325"><a href="#cb56-325" aria-hidden="true" tabindex="-1"></a>skystream_knn <span class="ot">&lt;-</span> skystream <span class="sc">%&gt;%</span></span>
<span id="cb56-326"><a href="#cb56-326" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Make “Churned” the first level so tidymodels treats Churned as the positive class</span></span>
<span id="cb56-327"><a href="#cb56-327" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Churn =</span> <span class="fu">factor</span>(Churn, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">0</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Churned"</span>, <span class="st">"Active"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb56-328"><a href="#cb56-328" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-329"><a href="#cb56-329" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ensure numericals are numeric</span></span>
<span id="cb56-330"><a href="#cb56-330" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">all_of</span>(num_cols), as.numeric)) <span class="sc">%&gt;%</span></span>
<span id="cb56-331"><a href="#cb56-331" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-332"><a href="#cb56-332" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove columns not suitable as KNN features </span></span>
<span id="cb56-333"><a href="#cb56-333" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>CustomerID, <span class="sc">-</span>JoinDate, <span class="sc">-</span>CancelDate, <span class="sc">-</span>RevenueYTD) <span class="sc">%&gt;%</span></span>
<span id="cb56-334"><a href="#cb56-334" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-335"><a href="#cb56-335" aria-hidden="true" tabindex="-1"></a>  <span class="co"># One-hot encode categoricals (drop first level to avoid redundancy)</span></span>
<span id="cb56-336"><a href="#cb56-336" aria-hidden="true" tabindex="-1"></a>  fastDummies<span class="sc">::</span><span class="fu">dummy_cols</span>(</span>
<span id="cb56-337"><a href="#cb56-337" aria-hidden="true" tabindex="-1"></a>    <span class="at">select_columns =</span> cat_cols,</span>
<span id="cb56-338"><a href="#cb56-338" aria-hidden="true" tabindex="-1"></a>    <span class="at">remove_first_dummy =</span> <span class="cn">TRUE</span>,</span>
<span id="cb56-339"><a href="#cb56-339" aria-hidden="true" tabindex="-1"></a>    <span class="at">remove_selected_columns =</span> <span class="cn">TRUE</span></span>
<span id="cb56-340"><a href="#cb56-340" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb56-341"><a href="#cb56-341" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb56-342"><a href="#cb56-342" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Ensure column names are all in tidy format</span></span>
<span id="cb56-343"><a href="#cb56-343" aria-hidden="true" tabindex="-1"></a>   <span class="fu">rename_with</span>(<span class="sc">~</span> <span class="fu">to_any_case</span>(., <span class="at">case =</span> <span class="st">"upper_camel"</span>)) </span>
<span id="cb56-344"><a href="#cb56-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-345"><a href="#cb56-345" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-346"><a href="#cb56-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-347"><a href="#cb56-347" aria-hidden="true" tabindex="-1"></a><span class="fu">## Creating the Model</span></span>
<span id="cb56-348"><a href="#cb56-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-349"><a href="#cb56-349" aria-hidden="true" tabindex="-1"></a>We set the seed using set.seed() to ensure the observations are random and consistent. We use initial_split() to divide the dataset, with 80% allocated for training and 20% for testing. Then, we use the strata = churned argument to ensure the class distribution of the churned variable is kept in both the training and testing sets. Finally, we extract the datasets for training and testing using split.</span>
<span id="cb56-350"><a href="#cb56-350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-353"><a href="#cb56-353" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-354"><a href="#cb56-354" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">867</span>)</span>
<span id="cb56-355"><a href="#cb56-355" aria-hidden="true" tabindex="-1"></a>Split80 <span class="ot">=</span> <span class="fu">initial_split</span>(skystream_knn, <span class="at">prop =</span> <span class="fl">0.80</span>, <span class="at">strata =</span> Churn)</span>
<span id="cb56-356"><a href="#cb56-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-357"><a href="#cb56-357" aria-hidden="true" tabindex="-1"></a>DataTrain <span class="ot">&lt;-</span> <span class="fu">training</span>(Split80) </span>
<span id="cb56-358"><a href="#cb56-358" aria-hidden="true" tabindex="-1"></a>DataTest  <span class="ot">&lt;-</span> <span class="fu">testing</span>(Split80)  </span>
<span id="cb56-359"><a href="#cb56-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-360"><a href="#cb56-360" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-361"><a href="#cb56-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-362"><a href="#cb56-362" aria-hidden="true" tabindex="-1"></a>We define the recipe for preprocessing. We specify the recipe with Churn \~ ., which means all other columns, such as Age and NumberMonthsActive, will be used to predict whether a customer churned.</span>
<span id="cb56-363"><a href="#cb56-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-364"><a href="#cb56-364" aria-hidden="true" tabindex="-1"></a>We use step_normalize(all_predictors()) to scale all predictor variables and ensure they are all within the same scale.</span>
<span id="cb56-365"><a href="#cb56-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-366"><a href="#cb56-366" aria-hidden="true" tabindex="-1"></a>Since our 900 observation data is highly imbalanced, churned users comprising less than 10% of the user base, we use SMOTE from the themis package to create new synthetic samples of the minority class. SMOTE can create realistic "synthetic churn customers" so the KNN model doesn’t always default to predicting “Active.” It is less likely to overfit compared to naive oversampling in order to balance classes.</span>
<span id="cb56-367"><a href="#cb56-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-370"><a href="#cb56-370" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-371"><a href="#cb56-371" aria-hidden="true" tabindex="-1"></a>Recipe <span class="ot">=</span> <span class="fu">recipe</span>(Churn <span class="sc">~</span> ., <span class="at">data =</span> DataTrain) <span class="sc">|&gt;</span></span>
<span id="cb56-372"><a href="#cb56-372" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_predictors</span>()) <span class="sc">%&gt;%</span>  <span class="co"># scale numeric features</span></span>
<span id="cb56-373"><a href="#cb56-373" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_smote</span>(Churn)<span class="co"># apply SMOTE to balance churn vs active </span></span>
<span id="cb56-374"><a href="#cb56-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-375"><a href="#cb56-375" aria-hidden="true" tabindex="-1"></a>ModelDesign <span class="ot">=</span> <span class="fu">nearest_neighbor</span>(<span class="at">neighbors=</span><span class="fu">tune</span>()) <span class="sc">|&gt;</span></span>
<span id="cb56-376"><a href="#cb56-376" aria-hidden="true" tabindex="-1"></a>               <span class="fu">set_engine</span>(<span class="st">"kknn"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb56-377"><a href="#cb56-377" aria-hidden="true" tabindex="-1"></a>               <span class="fu">set_mode</span>(<span class="st">"classification"</span>)</span>
<span id="cb56-378"><a href="#cb56-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-379"><a href="#cb56-379" aria-hidden="true" tabindex="-1"></a>TuneWFModel <span class="ot">=</span> <span class="fu">workflow</span>() <span class="sc">|&gt;</span> </span>
<span id="cb56-380"><a href="#cb56-380" aria-hidden="true" tabindex="-1"></a>            <span class="fu">add_recipe</span>(Recipe) <span class="sc">|&gt;</span></span>
<span id="cb56-381"><a href="#cb56-381" aria-hidden="true" tabindex="-1"></a>            <span class="fu">add_model</span>(ModelDesign) </span>
<span id="cb56-382"><a href="#cb56-382" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-383"><a href="#cb56-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-384"><a href="#cb56-384" aria-hidden="true" tabindex="-1"></a>To avoid over-fitting, we are looking for the ideal number of neighbors (k) for our model to consider when classifying data points.To tune our model to the best value of *k,* we first create a hyper-parameter grid for tuning, a dataframe of possible k values (k = 1 to k = 15). For each 15 hyperparameters (k = 1 to k = 15), we will run 5 folds to cross-validate our data.</span>
<span id="cb56-385"><a href="#cb56-385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-388"><a href="#cb56-388" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-389"><a href="#cb56-389" aria-hidden="true" tabindex="-1"></a>ParGrid<span class="ot">=</span><span class="fu">data.frame</span>(<span class="at">neighbors=</span><span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">15</span>))</span>
<span id="cb56-390"><a href="#cb56-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-391"><a href="#cb56-391" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb56-392"><a href="#cb56-392" aria-hidden="true" tabindex="-1"></a>FoldsForTuning<span class="ot">=</span><span class="fu">vfold_cv</span>(DataTrain, <span class="at">v=</span><span class="dv">5</span>,</span>
<span id="cb56-393"><a href="#cb56-393" aria-hidden="true" tabindex="-1"></a>                        <span class="at">strata=</span>Churn)</span>
<span id="cb56-394"><a href="#cb56-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-395"><a href="#cb56-395" aria-hidden="true" tabindex="-1"></a>TuneResults<span class="ot">=</span><span class="fu">tune_grid</span>(TuneWFModel, <span class="at">resamples=</span>FoldsForTuning,</span>
<span id="cb56-396"><a href="#cb56-396" aria-hidden="true" tabindex="-1"></a>                      <span class="at">grid=</span>ParGrid, <span class="at">metrics=</span><span class="fu">metric_set</span>(roc_auc, yardstick<span class="sc">::</span>accuracy, sens, spec, f_meas)) <span class="co">#specify yardstick package to avoide conflict with rcompanion</span></span>
<span id="cb56-397"><a href="#cb56-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-398"><a href="#cb56-398" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(TuneResults)</span>
<span id="cb56-399"><a href="#cb56-399" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-400"><a href="#cb56-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-401"><a href="#cb56-401" aria-hidden="true" tabindex="-1"></a>After running the best hyper parameters. We went ahead and tuned the results using the metric ROC AUC, which is meant to find the balance between true positive rate and false positive rate. We want to find the optimal point where we have the highest percentage of correctly identified churn cases against the lowest number of wrongly identified active users.</span>
<span id="cb56-402"><a href="#cb56-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-403"><a href="#cb56-403" aria-hidden="true" tabindex="-1"></a>Based on ROC AUC, the best value for the hyper-parameter is 11.</span>
<span id="cb56-404"><a href="#cb56-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-407"><a href="#cb56-407" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-408"><a href="#cb56-408" aria-hidden="true" tabindex="-1"></a>BestHyperParameter<span class="ot">=</span><span class="fu">select_best</span>(TuneResults, <span class="at">metric=</span><span class="st">"roc_auc"</span>)</span>
<span id="cb56-409"><a href="#cb56-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-410"><a href="#cb56-410" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(BestHyperParameter)</span>
<span id="cb56-411"><a href="#cb56-411" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-412"><a href="#cb56-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-413"><a href="#cb56-413" aria-hidden="true" tabindex="-1"></a>Based on the results of our Best Model, we see that 6 users from the data were a true positives, meaning they were correctly predicted to churn base on our variables given. We have a **35% true positive rate**.</span>
<span id="cb56-414"><a href="#cb56-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-415"><a href="#cb56-415" aria-hidden="true" tabindex="-1"></a>True positive rate (also called sensitivity or recall) is the most important metric in churn prediction, given our goal is to correctly identify customers who will churn before they can do so. The model should be able to identify the highest number of churners correctly out of all those who actually end up churning churn.</span>
<span id="cb56-416"><a href="#cb56-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-417"><a href="#cb56-417" aria-hidden="true" tabindex="-1"></a>This model was able to identify only 35% of the churners, and the precision is very low. **Out of all the users model predicts will churn, only 20% actually churn**, the number of false positives is very high. This could lead to an inefficient allocation of the retention budget.</span>
<span id="cb56-418"><a href="#cb56-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-421"><a href="#cb56-421" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-422"><a href="#cb56-422" aria-hidden="true" tabindex="-1"></a>WFModelBest<span class="ot">=</span>TuneWFModel <span class="sc">|&gt;</span></span>
<span id="cb56-423"><a href="#cb56-423" aria-hidden="true" tabindex="-1"></a>  <span class="fu">finalize_workflow</span>(BestHyperParameter) <span class="sc">|&gt;</span></span>
<span id="cb56-424"><a href="#cb56-424" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(DataTrain)</span>
<span id="cb56-425"><a href="#cb56-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-426"><a href="#cb56-426" aria-hidden="true" tabindex="-1"></a>PredictionBestModel<span class="ot">=</span><span class="fu">augment</span>(WFModelBest, DataTest)</span>
<span id="cb56-427"><a href="#cb56-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-428"><a href="#cb56-428" aria-hidden="true" tabindex="-1"></a>cm <span class="ot">&lt;-</span> <span class="fu">conf_mat</span>(PredictionBestModel, <span class="at">truth=</span>Churn,</span>
<span id="cb56-429"><a href="#cb56-429" aria-hidden="true" tabindex="-1"></a>         <span class="at">estimate=</span>.pred_class)</span>
<span id="cb56-430"><a href="#cb56-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-431"><a href="#cb56-431" aria-hidden="true" tabindex="-1"></a>cm</span>
<span id="cb56-432"><a href="#cb56-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-433"><a href="#cb56-433" aria-hidden="true" tabindex="-1"></a>cm <span class="sc">%&gt;%</span> <span class="fu">summary</span>()</span>
<span id="cb56-434"><a href="#cb56-434" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-435"><a href="#cb56-435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-436"><a href="#cb56-436" aria-hidden="true" tabindex="-1"></a>We need to refine our model further to get the best results out of KNN.</span>
<span id="cb56-437"><a href="#cb56-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-438"><a href="#cb56-438" aria-hidden="true" tabindex="-1"></a><span class="fu">## Refining the Model</span></span>
<span id="cb56-439"><a href="#cb56-439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-440"><a href="#cb56-440" aria-hidden="true" tabindex="-1"></a><span class="fu">### Hyperparameter Grid</span></span>
<span id="cb56-441"><a href="#cb56-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-442"><a href="#cb56-442" aria-hidden="true" tabindex="-1"></a>Hyperparameter grids with k = <span class="sc">\[</span>1:30<span class="sc">\]</span> and k = <span class="sc">\[</span>1:60<span class="sc">\]</span> were also tested, which gave k = 11 (same as k = 15) and k = 43 as best hyperparameters. When k = 43 was used to tune the model, recall increased but precision dropped further.</span>
<span id="cb56-443"><a href="#cb56-443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-444"><a href="#cb56-444" aria-hidden="true" tabindex="-1"></a>As a result, we maintain k = 11 as a balanced hyperparameter, that also uses less computational power.</span>
<span id="cb56-445"><a href="#cb56-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-446"><a href="#cb56-446" aria-hidden="true" tabindex="-1"></a><span class="fu">### Thresholds</span></span>
<span id="cb56-447"><a href="#cb56-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-448"><a href="#cb56-448" aria-hidden="true" tabindex="-1"></a>As we have an imbalanced data set, we tuned our hyperparameter to ROC AUC, settling on the k with the highest AUC. ROC AUC trains our model to be good at ranking positives ahead of negatives regardless of the threshold.</span>
<span id="cb56-449"><a href="#cb56-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-450"><a href="#cb56-450" aria-hidden="true" tabindex="-1"></a>Now we can move on to determining the best threshold to balance recall and precision.</span>
<span id="cb56-451"><a href="#cb56-451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-452"><a href="#cb56-452" aria-hidden="true" tabindex="-1"></a>We will scan a range of thresholds and pick the threshold that maximizes F1.</span>
<span id="cb56-453"><a href="#cb56-453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-456"><a href="#cb56-456" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-457"><a href="#cb56-457" aria-hidden="true" tabindex="-1"></a><span class="co"># Try thresholds from 0.05 to 0.95</span></span>
<span id="cb56-458"><a href="#cb56-458" aria-hidden="true" tabindex="-1"></a>ths <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fl">0.05</span>, <span class="fl">0.95</span>, <span class="at">by =</span> <span class="fl">0.01</span>)</span>
<span id="cb56-459"><a href="#cb56-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-460"><a href="#cb56-460" aria-hidden="true" tabindex="-1"></a>scan_f1 <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(ths, <span class="cf">function</span>(t) {</span>
<span id="cb56-461"><a href="#cb56-461" aria-hidden="true" tabindex="-1"></a>  cls <span class="ot">&lt;-</span> <span class="fu">factor</span>(</span>
<span id="cb56-462"><a href="#cb56-462" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ifelse</span>(PredictionBestModel<span class="sc">$</span>.pred_Churned <span class="sc">&gt;=</span> t, <span class="st">"Churned"</span>, <span class="st">"Active"</span>),</span>
<span id="cb56-463"><a href="#cb56-463" aria-hidden="true" tabindex="-1"></a>    <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Churned"</span>,<span class="st">"Active"</span>)</span>
<span id="cb56-464"><a href="#cb56-464" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb56-465"><a href="#cb56-465" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb56-466"><a href="#cb56-466" aria-hidden="true" tabindex="-1"></a>    <span class="at">threshold =</span> t,</span>
<span id="cb56-467"><a href="#cb56-467" aria-hidden="true" tabindex="-1"></a>    <span class="at">f1 =</span> <span class="fu">f_meas_vec</span>(PredictionBestModel<span class="sc">$</span>Churn, cls, <span class="at">beta =</span> <span class="dv">1</span>),</span>
<span id="cb56-468"><a href="#cb56-468" aria-hidden="true" tabindex="-1"></a>    <span class="at">precision =</span> <span class="fu">precision_vec</span>(PredictionBestModel<span class="sc">$</span>Churn, cls),</span>
<span id="cb56-469"><a href="#cb56-469" aria-hidden="true" tabindex="-1"></a>    <span class="at">recall =</span> <span class="fu">sens_vec</span>(PredictionBestModel<span class="sc">$</span>Churn, cls)</span>
<span id="cb56-470"><a href="#cb56-470" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb56-471"><a href="#cb56-471" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb56-472"><a href="#cb56-472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-473"><a href="#cb56-473" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the best threshold by F1</span></span>
<span id="cb56-474"><a href="#cb56-474" aria-hidden="true" tabindex="-1"></a>best_thresh_f1 <span class="ot">&lt;-</span> scan_f1 <span class="sc">%&gt;%</span></span>
<span id="cb56-475"><a href="#cb56-475" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_max</span>(f1, <span class="at">n =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb56-476"><a href="#cb56-476" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(threshold)</span>
<span id="cb56-477"><a href="#cb56-477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-478"><a href="#cb56-478" aria-hidden="true" tabindex="-1"></a>best_thresh_f1 </span>
<span id="cb56-479"><a href="#cb56-479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-480"><a href="#cb56-480" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-481"><a href="#cb56-481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-482"><a href="#cb56-482" aria-hidden="true" tabindex="-1"></a>It appears that F1 peaks around t = 0.70. This increases our precision significantly while decreasing our recall.</span>
<span id="cb56-483"><a href="#cb56-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-486"><a href="#cb56-486" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-487"><a href="#cb56-487" aria-hidden="true" tabindex="-1"></a>f1_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(scan_f1, <span class="fu">aes</span>(<span class="at">x =</span> threshold, <span class="at">y =</span> f1)) <span class="sc">+</span></span>
<span id="cb56-488"><a href="#cb56-488" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"steelblue"</span>) <span class="sc">+</span></span>
<span id="cb56-489"><a href="#cb56-489" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"F1 Score Across Thresholds"</span>, <span class="at">y =</span> <span class="st">"F1 Score"</span>, <span class="at">x =</span> <span class="st">"Threshold"</span>)</span>
<span id="cb56-490"><a href="#cb56-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-491"><a href="#cb56-491" aria-hidden="true" tabindex="-1"></a> f1_plot2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(scan_f1, <span class="fu">aes</span>(<span class="at">x =</span> threshold, <span class="at">y =</span> precision)) <span class="sc">+</span></span>
<span id="cb56-492"><a href="#cb56-492" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"steelblue"</span>) <span class="sc">+</span></span>
<span id="cb56-493"><a href="#cb56-493" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Precision Score Across Thresholds"</span>, <span class="at">y =</span> <span class="st">"Precision Score"</span>, <span class="at">x =</span> <span class="st">"Threshold"</span>)</span>
<span id="cb56-494"><a href="#cb56-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-495"><a href="#cb56-495" aria-hidden="true" tabindex="-1"></a> f1_plot3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(scan_f1, <span class="fu">aes</span>(<span class="at">x =</span> threshold, <span class="at">y =</span> recall)) <span class="sc">+</span></span>
<span id="cb56-496"><a href="#cb56-496" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"steelblue"</span>) <span class="sc">+</span></span>
<span id="cb56-497"><a href="#cb56-497" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Recall Score Across Thresholds"</span>, <span class="at">y =</span> <span class="st">"Recall Score"</span>, <span class="at">x =</span> <span class="st">"Threshold"</span>)</span>
<span id="cb56-498"><a href="#cb56-498" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb56-499"><a href="#cb56-499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-500"><a href="#cb56-500" aria-hidden="true" tabindex="-1"></a> f1_plot <span class="sc">|</span> (f1_plot2 <span class="sc">/</span> f1_plot3)</span>
<span id="cb56-501"><a href="#cb56-501" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-502"><a href="#cb56-502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-503"><a href="#cb56-503" aria-hidden="true" tabindex="-1"></a>Using 0.70 as a threshold, we achieve a more balanced model compared to the default threshold of 0.5, which we got after tuning our model for ROC AUC.</span>
<span id="cb56-504"><a href="#cb56-504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-505"><a href="#cb56-505" aria-hidden="true" tabindex="-1"></a>Precision is now at 0.35, and recall at 0.35.</span>
<span id="cb56-506"><a href="#cb56-506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-509"><a href="#cb56-509" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-510"><a href="#cb56-510" aria-hidden="true" tabindex="-1"></a>PredictionBestModel_f1 <span class="ot">&lt;-</span> PredictionBestModel <span class="sc">%&gt;%</span></span>
<span id="cb56-511"><a href="#cb56-511" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb56-512"><a href="#cb56-512" aria-hidden="true" tabindex="-1"></a>    <span class="at">.pred_class_opt =</span> <span class="fu">factor</span>(</span>
<span id="cb56-513"><a href="#cb56-513" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ifelse</span>(.pred_Churned <span class="sc">&gt;=</span> best_thresh_f1, <span class="st">"Churned"</span>, <span class="st">"Active"</span>),</span>
<span id="cb56-514"><a href="#cb56-514" aria-hidden="true" tabindex="-1"></a>      <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Churned"</span>,<span class="st">"Active"</span>)</span>
<span id="cb56-515"><a href="#cb56-515" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb56-516"><a href="#cb56-516" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb56-517"><a href="#cb56-517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-518"><a href="#cb56-518" aria-hidden="true" tabindex="-1"></a>cm_f1 <span class="ot">&lt;-</span> <span class="fu">conf_mat</span>(PredictionBestModel_f1, <span class="at">truth =</span> Churn, <span class="at">estimate =</span> .pred_class_opt)</span>
<span id="cb56-519"><a href="#cb56-519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-520"><a href="#cb56-520" aria-hidden="true" tabindex="-1"></a>cm_f1</span>
<span id="cb56-521"><a href="#cb56-521" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-522"><a href="#cb56-522" aria-hidden="true" tabindex="-1"></a>cm_f1 <span class="sc">%&gt;%</span></span>
<span id="cb56-523"><a href="#cb56-523" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>()</span>
<span id="cb56-524"><a href="#cb56-524" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-525"><a href="#cb56-525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-526"><a href="#cb56-526" aria-hidden="true" tabindex="-1"></a>**Compared to the previous model,** **this model is better at eliminating false churn cases**. However, we are also missing out on more true positives due to the increased threshold for churn prediction.</span>
<span id="cb56-527"><a href="#cb56-527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-530"><a href="#cb56-530" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-531"><a href="#cb56-531" aria-hidden="true" tabindex="-1"></a>cm_f1</span>
<span id="cb56-532"><a href="#cb56-532" aria-hidden="true" tabindex="-1"></a>cm </span>
<span id="cb56-533"><a href="#cb56-533" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-534"><a href="#cb56-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-535"><a href="#cb56-535" aria-hidden="true" tabindex="-1"></a>We will refine further by changing weights.</span>
<span id="cb56-536"><a href="#cb56-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-537"><a href="#cb56-537" aria-hidden="true" tabindex="-1"></a><span class="fu">### Inverse Distance Weighting</span></span>
<span id="cb56-538"><a href="#cb56-538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-539"><a href="#cb56-539" aria-hidden="true" tabindex="-1"></a>In our initial KNN model design, every neighbor were counted equally by default (weight_func = "rectangular"). This only takes into account the class of nearby points when predicting, ignoring distance. Inverse distance weighting ("inv") makes KNN more sensitive to local structure, reducing the impact of “distant” neighbors by giving neighbors closer to the query point higher weight.</span>
<span id="cb56-540"><a href="#cb56-540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-541"><a href="#cb56-541" aria-hidden="true" tabindex="-1"></a>Simply using IDW with ROC, yielded higher recall than our first model.</span>
<span id="cb56-542"><a href="#cb56-542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-545"><a href="#cb56-545" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-546"><a href="#cb56-546" aria-hidden="true" tabindex="-1"></a>ModelDesign_inv<span class="ot">=</span><span class="fu">nearest_neighbor</span>(<span class="at">neighbors=</span><span class="fu">tune</span>(), <span class="at">weight_func =</span> <span class="st">"inv"</span>) <span class="sc">|&gt;</span></span>
<span id="cb56-547"><a href="#cb56-547" aria-hidden="true" tabindex="-1"></a>               <span class="fu">set_engine</span>(<span class="st">"kknn"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb56-548"><a href="#cb56-548" aria-hidden="true" tabindex="-1"></a>               <span class="fu">set_mode</span>(<span class="st">"classification"</span>)</span>
<span id="cb56-549"><a href="#cb56-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-550"><a href="#cb56-550" aria-hidden="true" tabindex="-1"></a>TuneWFModel_inv<span class="ot">=</span><span class="fu">workflow</span>() <span class="sc">|&gt;</span> </span>
<span id="cb56-551"><a href="#cb56-551" aria-hidden="true" tabindex="-1"></a>            <span class="fu">add_recipe</span>(Recipe) <span class="sc">|&gt;</span></span>
<span id="cb56-552"><a href="#cb56-552" aria-hidden="true" tabindex="-1"></a>            <span class="fu">add_model</span>(ModelDesign_inv) </span>
<span id="cb56-553"><a href="#cb56-553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-554"><a href="#cb56-554" aria-hidden="true" tabindex="-1"></a>ParGrid<span class="ot">=</span><span class="fu">data.frame</span>(<span class="at">neighbors=</span><span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">15</span>))</span>
<span id="cb56-555"><a href="#cb56-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-556"><a href="#cb56-556" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb56-557"><a href="#cb56-557" aria-hidden="true" tabindex="-1"></a>FoldsForTuning<span class="ot">=</span><span class="fu">vfold_cv</span>(DataTrain, <span class="at">v=</span><span class="dv">5</span>,</span>
<span id="cb56-558"><a href="#cb56-558" aria-hidden="true" tabindex="-1"></a>                        <span class="at">strata=</span>Churn)</span>
<span id="cb56-559"><a href="#cb56-559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-560"><a href="#cb56-560" aria-hidden="true" tabindex="-1"></a>TuneResults_inv<span class="ot">=</span><span class="fu">tune_grid</span>(TuneWFModel_inv, <span class="at">resamples=</span>FoldsForTuning,</span>
<span id="cb56-561"><a href="#cb56-561" aria-hidden="true" tabindex="-1"></a>                      <span class="at">grid=</span>ParGrid, <span class="at">metrics=</span><span class="fu">metric_set</span>(roc_auc, yardstick<span class="sc">::</span>accuracy, sens, spec, f_meas))</span>
<span id="cb56-562"><a href="#cb56-562" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-563"><a href="#cb56-563" aria-hidden="true" tabindex="-1"></a>BestHyperParameter_inv<span class="ot">=</span><span class="fu">select_best</span>(TuneResults_inv, <span class="at">metric=</span><span class="st">"roc_auc"</span>)</span>
<span id="cb56-564"><a href="#cb56-564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-565"><a href="#cb56-565" aria-hidden="true" tabindex="-1"></a>WFModelBest_inv<span class="ot">=</span>TuneWFModel_inv <span class="sc">|&gt;</span></span>
<span id="cb56-566"><a href="#cb56-566" aria-hidden="true" tabindex="-1"></a>  <span class="fu">finalize_workflow</span>(BestHyperParameter_inv) <span class="sc">|&gt;</span></span>
<span id="cb56-567"><a href="#cb56-567" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(DataTrain)</span>
<span id="cb56-568"><a href="#cb56-568" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-569"><a href="#cb56-569" aria-hidden="true" tabindex="-1"></a>PredictionBestModel_inv<span class="ot">=</span><span class="fu">augment</span>(WFModelBest_inv, DataTest)</span>
<span id="cb56-570"><a href="#cb56-570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-571"><a href="#cb56-571" aria-hidden="true" tabindex="-1"></a>cm_inv <span class="ot">&lt;-</span> <span class="fu">conf_mat</span>(PredictionBestModel_inv, <span class="at">truth=</span>Churn,</span>
<span id="cb56-572"><a href="#cb56-572" aria-hidden="true" tabindex="-1"></a>         <span class="at">estimate=</span>.pred_class)</span>
<span id="cb56-573"><a href="#cb56-573" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-574"><a href="#cb56-574" aria-hidden="true" tabindex="-1"></a>cm_inv</span>
<span id="cb56-575"><a href="#cb56-575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-576"><a href="#cb56-576" aria-hidden="true" tabindex="-1"></a>cm_inv <span class="sc">%&gt;%</span></span>
<span id="cb56-577"><a href="#cb56-577" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>()</span>
<span id="cb56-578"><a href="#cb56-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-579"><a href="#cb56-579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-580"><a href="#cb56-580" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-581"><a href="#cb56-581" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-582"><a href="#cb56-582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-583"><a href="#cb56-583" aria-hidden="true" tabindex="-1"></a>Setting the threshold to 0.70, again increased precision but decreased recall.</span>
<span id="cb56-584"><a href="#cb56-584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-587"><a href="#cb56-587" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-588"><a href="#cb56-588" aria-hidden="true" tabindex="-1"></a>scan_f1_inv <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(ths, <span class="cf">function</span>(t) {</span>
<span id="cb56-589"><a href="#cb56-589" aria-hidden="true" tabindex="-1"></a>  cls <span class="ot">&lt;-</span> <span class="fu">factor</span>(</span>
<span id="cb56-590"><a href="#cb56-590" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ifelse</span>(PredictionBestModel_inv<span class="sc">$</span>.pred_Churned <span class="sc">&gt;=</span> t, <span class="st">"Churned"</span>, <span class="st">"Active"</span>),</span>
<span id="cb56-591"><a href="#cb56-591" aria-hidden="true" tabindex="-1"></a>    <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Churned"</span>,<span class="st">"Active"</span>)</span>
<span id="cb56-592"><a href="#cb56-592" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb56-593"><a href="#cb56-593" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb56-594"><a href="#cb56-594" aria-hidden="true" tabindex="-1"></a>    <span class="at">threshold =</span> t,</span>
<span id="cb56-595"><a href="#cb56-595" aria-hidden="true" tabindex="-1"></a>    <span class="at">f1 =</span> <span class="fu">f_meas_vec</span>(PredictionBestModel_inv<span class="sc">$</span>Churn, cls, <span class="at">beta =</span> <span class="dv">1</span>),</span>
<span id="cb56-596"><a href="#cb56-596" aria-hidden="true" tabindex="-1"></a>    <span class="at">precision =</span> <span class="fu">precision_vec</span>(PredictionBestModel_inv<span class="sc">$</span>Churn, cls),</span>
<span id="cb56-597"><a href="#cb56-597" aria-hidden="true" tabindex="-1"></a>    <span class="at">recall =</span> <span class="fu">sens_vec</span>(PredictionBestModel_inv<span class="sc">$</span>Churn, cls)</span>
<span id="cb56-598"><a href="#cb56-598" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb56-599"><a href="#cb56-599" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb56-600"><a href="#cb56-600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-601"><a href="#cb56-601" aria-hidden="true" tabindex="-1"></a>best_thresh_f1_inv <span class="ot">&lt;-</span> scan_f1_inv <span class="sc">%&gt;%</span> <span class="co"># Show the best threshold by F1</span></span>
<span id="cb56-602"><a href="#cb56-602" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_max</span>(f1, <span class="at">n =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb56-603"><a href="#cb56-603" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(threshold)</span>
<span id="cb56-604"><a href="#cb56-604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-605"><a href="#cb56-605" aria-hidden="true" tabindex="-1"></a>PredictionBestModel_f1_inv <span class="ot">&lt;-</span> PredictionBestModel_inv <span class="sc">%&gt;%</span></span>
<span id="cb56-606"><a href="#cb56-606" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb56-607"><a href="#cb56-607" aria-hidden="true" tabindex="-1"></a>    <span class="at">.pred_class_opt =</span> <span class="fu">factor</span>(</span>
<span id="cb56-608"><a href="#cb56-608" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ifelse</span>(.pred_Churned <span class="sc">&gt;=</span> best_thresh_f1_inv, <span class="st">"Churned"</span>, <span class="st">"Active"</span>),</span>
<span id="cb56-609"><a href="#cb56-609" aria-hidden="true" tabindex="-1"></a>      <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Churned"</span>,<span class="st">"Active"</span>)</span>
<span id="cb56-610"><a href="#cb56-610" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb56-611"><a href="#cb56-611" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb56-612"><a href="#cb56-612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-613"><a href="#cb56-613" aria-hidden="true" tabindex="-1"></a>cm_inv_f1 <span class="ot">&lt;-</span> <span class="fu">conf_mat</span>(PredictionBestModel_f1_inv, <span class="at">truth =</span> Churn, <span class="at">estimate =</span> .pred_class_opt)</span>
<span id="cb56-614"><a href="#cb56-614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-615"><a href="#cb56-615" aria-hidden="true" tabindex="-1"></a>cm_inv_f1</span>
<span id="cb56-616"><a href="#cb56-616" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-617"><a href="#cb56-617" aria-hidden="true" tabindex="-1"></a>cm_inv_f1 <span class="sc">%&gt;%</span></span>
<span id="cb56-618"><a href="#cb56-618" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>()</span>
<span id="cb56-619"><a href="#cb56-619" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-620"><a href="#cb56-620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-621"><a href="#cb56-621" aria-hidden="true" tabindex="-1"></a><span class="fu">### Manhattan Distance Weighting</span></span>
<span id="cb56-622"><a href="#cb56-622" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-623"><a href="#cb56-623" aria-hidden="true" tabindex="-1"></a>Our previous models used Euclidean distance by default (dist_power = 2), which is sensitive to large differences in any single feature since squaring exaggerates outliers.</span>
<span id="cb56-624"><a href="#cb56-624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-625"><a href="#cb56-625" aria-hidden="true" tabindex="-1"></a>We can change this to Manhattan distance, which is more robust to high-dimensional and sparse data (like one-hot encoded variables), since it just adds absolute differences without squaring them.</span>
<span id="cb56-626"><a href="#cb56-626" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-627"><a href="#cb56-627" aria-hidden="true" tabindex="-1"></a>Our dataset has lots of dummy variables and scaled numerics. Therefore, we may set our argument to favor Manhattan (dist_power = 1) to treat all feature differences more evenly.</span>
<span id="cb56-628"><a href="#cb56-628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-629"><a href="#cb56-629" aria-hidden="true" tabindex="-1"></a>Even without optimized for F1 score, Manhattan Distance Weighting gives us the highest recall and precision we obtained so far.</span>
<span id="cb56-630"><a href="#cb56-630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-633"><a href="#cb56-633" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-634"><a href="#cb56-634" aria-hidden="true" tabindex="-1"></a>ModelDesign_man<span class="ot">=</span><span class="fu">nearest_neighbor</span>(<span class="at">neighbors=</span><span class="fu">tune</span>(), <span class="at">weight_func =</span> <span class="st">"inv"</span>, <span class="at">dist_power =</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb56-635"><a href="#cb56-635" aria-hidden="true" tabindex="-1"></a>               <span class="fu">set_engine</span>(<span class="st">"kknn"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb56-636"><a href="#cb56-636" aria-hidden="true" tabindex="-1"></a>               <span class="fu">set_mode</span>(<span class="st">"classification"</span>)</span>
<span id="cb56-637"><a href="#cb56-637" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-638"><a href="#cb56-638" aria-hidden="true" tabindex="-1"></a>TuneWFModel_man<span class="ot">=</span><span class="fu">workflow</span>() <span class="sc">|&gt;</span> </span>
<span id="cb56-639"><a href="#cb56-639" aria-hidden="true" tabindex="-1"></a>            <span class="fu">add_recipe</span>(Recipe) <span class="sc">|&gt;</span></span>
<span id="cb56-640"><a href="#cb56-640" aria-hidden="true" tabindex="-1"></a>            <span class="fu">add_model</span>(ModelDesign_man) </span>
<span id="cb56-641"><a href="#cb56-641" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-642"><a href="#cb56-642" aria-hidden="true" tabindex="-1"></a>ParGrid<span class="ot">=</span><span class="fu">data.frame</span>(<span class="at">neighbors=</span><span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">15</span>))</span>
<span id="cb56-643"><a href="#cb56-643" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-644"><a href="#cb56-644" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-645"><a href="#cb56-645" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb56-646"><a href="#cb56-646" aria-hidden="true" tabindex="-1"></a>FoldsForTuning<span class="ot">=</span><span class="fu">vfold_cv</span>(DataTrain, <span class="at">v=</span><span class="dv">5</span>,</span>
<span id="cb56-647"><a href="#cb56-647" aria-hidden="true" tabindex="-1"></a>                        <span class="at">strata=</span>Churn)</span>
<span id="cb56-648"><a href="#cb56-648" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-649"><a href="#cb56-649" aria-hidden="true" tabindex="-1"></a>TuneResults_man<span class="ot">=</span><span class="fu">tune_grid</span>(TuneWFModel_man, <span class="at">resamples=</span>FoldsForTuning,</span>
<span id="cb56-650"><a href="#cb56-650" aria-hidden="true" tabindex="-1"></a>                      <span class="at">grid=</span>ParGrid, <span class="at">metrics=</span><span class="fu">metric_set</span>(roc_auc, yardstick<span class="sc">::</span>accuracy, sens, spec, f_meas))</span>
<span id="cb56-651"><a href="#cb56-651" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-652"><a href="#cb56-652" aria-hidden="true" tabindex="-1"></a>BestHyperParameter_man<span class="ot">=</span><span class="fu">select_best</span>(TuneResults_man, <span class="at">metric=</span><span class="st">"roc_auc"</span>)</span>
<span id="cb56-653"><a href="#cb56-653" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-654"><a href="#cb56-654" aria-hidden="true" tabindex="-1"></a>WFModelBest_man<span class="ot">=</span>TuneWFModel_man <span class="sc">|&gt;</span></span>
<span id="cb56-655"><a href="#cb56-655" aria-hidden="true" tabindex="-1"></a>  <span class="fu">finalize_workflow</span>(BestHyperParameter_man) <span class="sc">|&gt;</span></span>
<span id="cb56-656"><a href="#cb56-656" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(DataTrain)</span>
<span id="cb56-657"><a href="#cb56-657" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-658"><a href="#cb56-658" aria-hidden="true" tabindex="-1"></a>PredictionBestModel_man<span class="ot">=</span><span class="fu">augment</span>(WFModelBest_man, DataTest)</span>
<span id="cb56-659"><a href="#cb56-659" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-660"><a href="#cb56-660" aria-hidden="true" tabindex="-1"></a>cm_man <span class="ot">&lt;-</span> <span class="fu">conf_mat</span>(PredictionBestModel_man, <span class="at">truth=</span>Churn,</span>
<span id="cb56-661"><a href="#cb56-661" aria-hidden="true" tabindex="-1"></a>         <span class="at">estimate=</span>.pred_class)</span>
<span id="cb56-662"><a href="#cb56-662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-663"><a href="#cb56-663" aria-hidden="true" tabindex="-1"></a>cm_man</span>
<span id="cb56-664"><a href="#cb56-664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-665"><a href="#cb56-665" aria-hidden="true" tabindex="-1"></a>cm_man <span class="sc">%&gt;%</span></span>
<span id="cb56-666"><a href="#cb56-666" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>()</span>
<span id="cb56-667"><a href="#cb56-667" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-668"><a href="#cb56-668" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-669"><a href="#cb56-669" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-670"><a href="#cb56-670" aria-hidden="true" tabindex="-1"></a>After optimizing for the F1 score, we **achieved 47% recall with 57% precision.**</span>
<span id="cb56-671"><a href="#cb56-671" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-674"><a href="#cb56-674" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-675"><a href="#cb56-675" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the best threshold by F1</span></span>
<span id="cb56-676"><a href="#cb56-676" aria-hidden="true" tabindex="-1"></a>scan_f1_man <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(ths, <span class="cf">function</span>(t) {</span>
<span id="cb56-677"><a href="#cb56-677" aria-hidden="true" tabindex="-1"></a>  cls <span class="ot">&lt;-</span> <span class="fu">factor</span>(</span>
<span id="cb56-678"><a href="#cb56-678" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ifelse</span>(PredictionBestModel_man<span class="sc">$</span>.pred_Churned <span class="sc">&gt;=</span> t, <span class="st">"Churned"</span>, <span class="st">"Active"</span>),</span>
<span id="cb56-679"><a href="#cb56-679" aria-hidden="true" tabindex="-1"></a>    <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Churned"</span>,<span class="st">"Active"</span>)</span>
<span id="cb56-680"><a href="#cb56-680" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb56-681"><a href="#cb56-681" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb56-682"><a href="#cb56-682" aria-hidden="true" tabindex="-1"></a>    <span class="at">threshold =</span> t,</span>
<span id="cb56-683"><a href="#cb56-683" aria-hidden="true" tabindex="-1"></a>    <span class="at">f1 =</span> <span class="fu">f_meas_vec</span>(PredictionBestModel_man<span class="sc">$</span>Churn, cls, <span class="at">beta =</span> <span class="dv">1</span>),</span>
<span id="cb56-684"><a href="#cb56-684" aria-hidden="true" tabindex="-1"></a>    <span class="at">precision =</span> <span class="fu">precision_vec</span>(PredictionBestModel_man<span class="sc">$</span>Churn, cls),</span>
<span id="cb56-685"><a href="#cb56-685" aria-hidden="true" tabindex="-1"></a>    <span class="at">recall =</span> <span class="fu">sens_vec</span>(PredictionBestModel_man<span class="sc">$</span>Churn, cls)</span>
<span id="cb56-686"><a href="#cb56-686" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb56-687"><a href="#cb56-687" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb56-688"><a href="#cb56-688" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-689"><a href="#cb56-689" aria-hidden="true" tabindex="-1"></a>best_thresh_f1_man <span class="ot">&lt;-</span> scan_f1_man <span class="sc">%&gt;%</span> <span class="co"># Show the best threshold by F1</span></span>
<span id="cb56-690"><a href="#cb56-690" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_max</span>(f1, <span class="at">n =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb56-691"><a href="#cb56-691" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(threshold)</span>
<span id="cb56-692"><a href="#cb56-692" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-693"><a href="#cb56-693" aria-hidden="true" tabindex="-1"></a>best_thresh_f1_man </span>
<span id="cb56-694"><a href="#cb56-694" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-695"><a href="#cb56-695" aria-hidden="true" tabindex="-1"></a>PredictionBestModel_f1_man <span class="ot">&lt;-</span> PredictionBestModel_man <span class="sc">%&gt;%</span></span>
<span id="cb56-696"><a href="#cb56-696" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb56-697"><a href="#cb56-697" aria-hidden="true" tabindex="-1"></a>    <span class="at">.pred_class_opt =</span> <span class="fu">factor</span>(</span>
<span id="cb56-698"><a href="#cb56-698" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ifelse</span>(.pred_Churned <span class="sc">&gt;=</span> best_thresh_f1_man, <span class="st">"Churned"</span>, <span class="st">"Active"</span>),</span>
<span id="cb56-699"><a href="#cb56-699" aria-hidden="true" tabindex="-1"></a>      <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Churned"</span>,<span class="st">"Active"</span>)</span>
<span id="cb56-700"><a href="#cb56-700" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb56-701"><a href="#cb56-701" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb56-702"><a href="#cb56-702" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-703"><a href="#cb56-703" aria-hidden="true" tabindex="-1"></a>cm_man_f1 <span class="ot">&lt;-</span> <span class="fu">conf_mat</span>(PredictionBestModel_f1_man, <span class="at">truth =</span> Churn, <span class="at">estimate =</span> .pred_class_opt)</span>
<span id="cb56-704"><a href="#cb56-704" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-705"><a href="#cb56-705" aria-hidden="true" tabindex="-1"></a>cm_man_f1 <span class="sc">%&gt;%</span></span>
<span id="cb56-706"><a href="#cb56-706" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>()</span>
<span id="cb56-707"><a href="#cb56-707" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-708"><a href="#cb56-708" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-709"><a href="#cb56-709" aria-hidden="true" tabindex="-1"></a><span class="fu">## Conclusion</span></span>
<span id="cb56-710"><a href="#cb56-710" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-711"><a href="#cb56-711" aria-hidden="true" tabindex="-1"></a>Our final KNN model predicts 47% of all churn cases correctly with 57% precision.</span>
<span id="cb56-712"><a href="#cb56-712" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-715"><a href="#cb56-715" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-716"><a href="#cb56-716" aria-hidden="true" tabindex="-1"></a>cm_man_f1</span>
<span id="cb56-717"><a href="#cb56-717" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-718"><a href="#cb56-718" aria-hidden="true" tabindex="-1"></a>cm_man_f1 <span class="sc">%&gt;%</span></span>
<span id="cb56-719"><a href="#cb56-719" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>()</span>
<span id="cb56-720"><a href="#cb56-720" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-721"><a href="#cb56-721" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-722"><a href="#cb56-722" aria-hidden="true" tabindex="-1"></a>Through several optimizations, we transformed KNN into a model that provides practical business value for churn prediction. The initial version, using Euclidean distance and equal neighbor weighting, was prone to misclassifying churners because the majority “Active” class dominated.</span>
<span id="cb56-723"><a href="#cb56-723" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-724"><a href="#cb56-724" aria-hidden="true" tabindex="-1"></a>By introducing **inverse distance weighting**, the model became more sensitive to customers whose behavior closely resembled churners, improving its ability to detect at-risk users. Switching to **Manhattan distance** further improved results by better handling the many categorical (dummy) features in our dataset, allowing the model to differentiate churners more effectively. Finally, instead of relying on the default 0.5 probability cutoff, we optimized the **decision threshold** for the F1 score, which balanced the need to catch more churners (recall) with the need to reduce false alarms (precision).</span>
<span id="cb56-725"><a href="#cb56-725" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-726"><a href="#cb56-726" aria-hidden="true" tabindex="-1"></a>Together, these changes yielded a model that can more reliably flag customers with genuine churn risk, enabling more targeted and cost-effective retention campaigns.</span>
<span id="cb56-727"><a href="#cb56-727" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-728"><a href="#cb56-728" aria-hidden="true" tabindex="-1"></a><span class="fu">### Next Steps</span></span>
<span id="cb56-729"><a href="#cb56-729" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-730"><a href="#cb56-730" aria-hidden="true" tabindex="-1"></a>Looking ahead, we recommend benchmarking this improved KNN against **tree-based methods such as Random Forest**. These algorithms often outperform KNN on imbalanced, high-dimensional data and may further increase recall without sacrificing precision. Incorporating **cost-sensitive evaluation** (penalizing missed churns more heavily) and **feature engineering** to capture behavioral trends (e.g., declining engagement over time) would also align the modeling process more closely with business objectives. This will ensure that our churn detection framework continues to evolve into a robust, actionable tool for customer retention strategy.</span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



<script src="../../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>